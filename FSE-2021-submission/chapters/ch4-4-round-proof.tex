
\section{Beyond-Birthday-Bound Security for 4-Round SPNs}
\label{section:security of 4-round SPNs}

%In this section, we prove beyond-birthday-bound SPRP security for 4-round linear SPNs.
Concretely, let $\spn_{\bfk}^T[\mathcal{S}]$ be the 4-round SPN using any linear transformations $T$. I.e.,
%
\begin{align}
\spn_{\bfk}^T[\mathcal{S}](x):=k_4\xor\overline{S_4}(k_3\xor T(\overline{S_3}(k_2\xor T(\overline{S_2}(k_1\xor T(\overline{S_1}(k_0\xor x))))))).
\label{eq:defn-4-round-spn}
\end{align}
%
We define good linear transformations to characterize their properties that are sufficient for $2n/3$-bit security.


\begin{definition}
	\label{defn:good-T}
	
	We say that a linear transformation
	%
	\[
	T=
	\left(
	\begin{array}{cccc}
	t_{1,1}~ & ~t_{1,2}~ & ~\cdots~ & ~t_{1,w}  \\
	t_{2,1}~ & ~t_{2,2}~ & ~\cdots~ & ~t_{2,w}  \\
	\vdots~   & ~\vdots~  &~\ddots~ & ~\vdots   \\
	t_{w,1}~ & ~t_{w,2}~ & ~\cdots~ & ~t_{w,w}  
	\end{array}
	\right),\ \ \ \ \ \ \ 
	T^{-1}=
	\left(
	\begin{array}{cccc}
	t_{1,1}'~ & ~t_{1,2}'~ & ~\cdots~ & ~t_{1,w}'  \\
	t_{2,1}'~ & ~t_{2,2}'~ & ~\cdots~ & ~t_{2,w}'  \\
	\vdots~   & ~\vdots~  &~\ddots~ & ~\vdots   \\
	t_{w,1}'~ & ~t_{w,2}'~ & ~\cdots~ & ~t_{w,w}'  
	\end{array}
	\right),
	\]
	%
	is {\it good}, if:
	\begin{enumerate}
		\item[1.] $T$ contains no zero entries, i.e., $t_{i,j}\neq 0$ for all $i,j\in\{1,\ldots,w\}$, and
		\item[2.] No row of $T$ contains redundant entries, i.e., for every $i$, $t_{i,j}\neq t_{i,j'}$ for all distinct indices $j,j'\in\{1,\ldots,w\}$; and
		\item[3.] $T^{-1}$ contains no zero entries, i.e., $t_{i,j}'\neq 0$ for all $i,j\in\{1,\ldots,w\}$, and
		\item[4.] No row of $T^{-1}$ contains redundant entries, i.e., for every $i$, $t_{i,j}'\neq t_{i,j'}'$ for all distinct indices $j,j'\in\{1,\ldots,w\}$.
	\end{enumerate}
\end{definition}
%
The 1st and 3rd conditions are also required for the birthday security of 3-round linear SPNs~\cite[Sect. 3]{EPRINT:DKSTZ17}. As mentioned in the Introduction, the 2nd and 4th conditions can be seen as a ``second order'' extension of the 1st and 3rd ones. To justify the soundness of this definition, we list several candidates in Appendix \ref{sec:candidates-good-linear}. Using such a good linear transformation $T$ and uniform and independent round keys, $\spn^T$ is beyond-birthday-bound secure.

%We show that $\spn^T$ is an SPRP as long as: (i) the linear layer $T$ is good as per Definition \ref{defn:good-T}, and (ii) the round keys $k_0,k_1,k_2,k_3,k_4$ are uniform and independent.

\begin{theorem}
\label{theorem:4-round-spn}

Assume $w\geq2$, and $p+wq\leq N/2$. Let $\spn_{\bfk}^T[\mathcal{S}]$ be a 4-round, linear SPN as defined by Eq. (\ref{eq:defn-4-round-spn}). If the round keys $\bfk=(k_0,k_1,k_2,k_3,k_4)$ are uniform and independent, and $T$ is good as per Definition \ref{defn:good-T}, then
%
\begin{align}
\operatorname{Adv}_{\spn^T}^{\mathrm{su}}(p, q) \leq~& 	\frac{3w^4q^2(p+2wq)}{N^2}+\frac{9w^2q(p+3wq)^2}{N^2}+\frac{q^2}{N^w},   
\notag   \\
\operatorname{Adv}_{\spn^T}^{\mathrm{mu}}(p, q) \leq~& \frac{3w^4q^2(p+3wq)}{N^2}+\frac{9w^2q(p+4wq)^2}{N^2}+\frac{q^2}{N^w}.
\notag
\end{align}
\end{theorem}
The proof of Theorem \ref{theorem:4-round-spn} relies on the following point-wise proximity result and on Lemmas \ref{lemma:h-coeff} and \ref{lemma:point-wise}.


\begin{lemma}
	\label{lemma:proximity-4-round}
	
	Assume $p+wq\leq N/2$. Let $\dis$ be a distinguisher in the single-user setting that makes $p$ primitive queries to each of $S_1,S_2,S_3$, and $S_4$, and makes $q$ construction queries. Then for any attainable
	transcript $\tau=(\mathcal{Q}_C,\mathcal{Q}_S)$, one has
	\begin{align}
	\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}
	\geq 1-
	\frac{3w^4q^2(p+2wq)}{N^2}-\frac{9w^2q(p+3wq)^2}{N^2}-\frac{q^2}{N^w}.
	\label{eq:bound-proximity-4-round}
	\end{align}
\end{lemma}




\subsection{Terminology, and Outline of the Proof}
\label{sec:proof-sketch-4-rounds}

Throughout the proof, we fix a distinguisher $\mathcal{D}$ as described in the statement and fix an attainable transcript $\tau =\left(\mathcal{Q}_{C}, \mathcal{Q}_{S}\right)$ obtained $\mathcal{D}$. Let
%
$$
\begin{aligned}
&\mathcal{Q}_{S_{1}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(1, u, v) \in \mathcal{Q}_{S} \right\},\\
&\mathcal{Q}_{S_{2}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(2, u, v) \in \mathcal{Q}_{S} \right\},\\
&\mathcal{Q}_{S_{3}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(3, u, v) \in \mathcal{Q}_{S} \right\},\\
&\mathcal{Q}_{S_{4}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(4, u, v) \in \mathcal{Q}_{S} \right\}.
\end{aligned}
$$
%
and denote the domains and ranges of $\mathcal{Q}_{S_{1}}^{(0)}, \mathcal{Q}_{S_{2}}^{(0)}, \mathcal{Q}_{S_{3}}^{(0)}, \mathcal{Q}_{S_{4}}^{(0)}$ by        {\small
%
\begin{align*}
&U_{1}^{(0)}=\left\{u_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(0)}\right\}, \quad V_{1}^{(0)}=\left\{v_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(0)}\right\},\\
&U_{2}^{(0)}=\left\{u_{2} \in\{0,1\}^{n}:\left(2, u_{2}, v_{2}\right) \in \mathcal{Q}_{S_{2}}^{(0)}\right\}, \quad V_{2}^{(0)}=\left\{v_{2} \in\{0,1\}^{n}:\left(2, u_{2}, v_{2}\right) \in \mathcal{Q}_{S_{2}}^{(0)}\right\},\\
&U_{3}^{(0)}=\left\{u_{3} \in\{0,1\}^{n}:\left(3, u_{3}, v_{3}\right) \in \mathcal{Q}_{S_{3}}^{(0)}\right\}, \quad V_{3}^{(0)}=\left\{v_{3} \in\{0,1\}^{n}:\left(3, u_{3}, v_{3}\right) \in \mathcal{Q}_{S_{3}}^{(0)}\right\},\\
&U_{4}^{(0)}=\left\{u_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(0)}\right\}, \quad V_{4}^{(0)}=\left\{v_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(0)}\right\}.
\end{align*}
}%
%



\subsubsection{Extending the transcripts}

Point-wise proximity is usually established by enhancing the transcripts with auxiliary random variables, defining a large enough set of ``good'' randomness, and then, for each choice of a good random variable, lower bounding the probability of observing this transcript. Such random variables typically include the keys, and are usually called good if the adversary cannot use the randomness to follow the path of computation of the encryption/decryption of a query up to a contradiction. To this end, we follow~\cite[Sect. 4.2]{C:CDKLST18} and define an extension of the transcript in order to gather enough information to allow simple definition of bad randomness. Then, instead of summing over the choice of the randomness, we will define an extension of the transcript, that will provide the necessary information, and then sum over every possible good extension. In detail, a transcript $\tau$ is first extended in the following manner:
\begin{itemize}
	\item At the end of the interaction between \dis and the real world $(\mathcal{S},\spn_{\bfk}^T[\mathcal{S}])$, we append $\tau$ with the keys $\bfk=(k_0,k_1,k_2,k_3,k_4)$ and the two random permutations $S_1,S_4$ in use;
	\item At the end of the interaction between \dis and the ideal world $(\mathcal{S},\widetilde{P})$, we append $\tau$ with randomly sampled keys $\bfk=(k_0,k_1,k_2,k_3,k_4)$ and the two random permutations $S_1,S_4$ in use.
\end{itemize}
Note that, in either case, it is equivalent to sampling two new random permutations $S_1,S_4$ such that $S_1\vdash\mathcal{Q}_{S_{1}}$ and $S_4\vdash\mathcal{Q}_{S_4}$ and appending them to $\tau$. With the above, for any $(x,y)\in\mathcal{Q}_C$ we define
%
$$a=T\big(\overline{S_1}\left(x \oplus k_{0}\right)\big),\ \ \  b=T^{-1}\big(\overline{S_{4}^{-1}}\left(y \oplus k_{4}\right)\big).$$
%
This extends the list $\mathcal{Q}_C$ into a list as follows:
%
$$\mathcal{Q}_C'=\big((x_1,a_1,b_1,y_1),\ldots,(x_q,a_q,b_q,y_q)\big).$$
%
With this new list, a colliding query is defined as a construction query $(x,y,a,b)\in\mathcal{Q}_C'$ as follows:
%
\begin{itemize}
%	\item[1.]
%	there exist an S-box query $(u,v)\in\mathcal{Q}_{S_2}^{(0)}$ and an integer $i \in\{1, \ldots, w\}$ such that $\left(a \oplus k_1\right)[i]=u$.
%	\item[2.]
%	there exist an S-box query $(u,v)\in\mathcal{Q}_{S_3}^{(0)}$ and an integer $i \in\{1, \ldots, w\}$ such that $\left(b \oplus T^{-1}(k_3)\right)[i]=v$.
	\item[1.] there exists an index $i \in\{1, \ldots, w\}$ such that $\left(a \oplus k_1\right)[i]\in U_2^{(0)}$.
	\item[2.] there exists an index $i \in\{1, \ldots, w\}$ such that $\left(b \oplus T^{-1}(k_3)\right)[i]\in V_3^{(0)}$.
	\item[3.] there exist a construction query $\left(x',a^{\prime}, b^{\prime},y'\right) \in \mathcal{Q}_{C}'$ and two indices $i,j \in\{1, \ldots, w\}$ such that $(x, a,i) \neq\left(x^{\prime},a', j\right)$ and $\left(a \oplus k_1\right)[i] = \left(a' \oplus k_1\right)[j]$.
	\item[4.] there exist a construction query $\left(x',a^{\prime}, b^{\prime},y'\right) \in \mathcal{Q}_{C}'$ and two indices $i,j \in\{1, \ldots, w\}$ such that $(x,a, i) \neq\left(x^{\prime},a', j\right)$ and $i \in\{1, \ldots, w\}$ such that $\left(b \oplus T^{-1}(k_3)\right)[i] = \left(b' \oplus T^{-1}(k_3)\right)[j]$.
\end{itemize}
%
%
Now we further introduce a new set $\mathcal{Q}_{S}'$ of S-box evaluations to complete the transcript extension. In detail, for each colliding query $(x,a,b,y)\in\mathcal{Q}_C'$, we will add tuples $\left(2, (a \oplus k_1)[i], v^{\prime}\right)_{1 \leq i \leq w}$ (if $(a, b)$ collides at the input of $S_2$) or $\left(3, u^{\prime}, (b \oplus T^{-1}(k_3))[i]\right)_{1 \leq i \leq w}$ (if $(a, b)$ collides at the output of $S_3$) to $\mathcal{Q}_{S}'$ by lazy sampling $v^{\prime}=S_2((a \oplus k_1)[i])$ or $u^{\prime}=S_3^{-1}((b \oplus T^{-1}(k_3))[i])$, as long as it has not been determined by any existing query in $\mathcal{Q}_S$.


An extended transcript of $\tau$ includes all the above additional information, i.e.,
%
$$\tau'=(\mathcal{Q}_{C}',\mathcal{Q}_{S},\mathcal{Q}_{S}',S_1,S_4,\bfk).$$
%
For each collision between a construction query and a primitive query, or between two construction queries, the extended transcript will contain enough information to compute a complete round of the evaluation of the SPN. This will be useful to lower bound the probability to get the transcript $\tau$ in the real world.


Below in Sect. \ref{sec:bad-tau-4-rounds}, we will show that the number of bad extended transcripts is small enough; then in Sect. \ref{sec:good-tau-4-rounds}, we show that the probability to obtain good extension in the real world is sufficiently close to that in the ideal world. These will complete the proof.




\subsection{Bad Transcript Extensions and Probability}
\label{sec:bad-tau-4-rounds}

The first step is to define the set of bad extended transcripts. Consider an attainable extended transcript $\tau'=(\mathcal{Q}_{C}',\mathcal{Q}_{S},\mathcal{Q}_{S}',S_1,S_4,\bfk)$. Let
%
$$
\begin{aligned}
%&\mathcal{Q}_{S_{1}}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(1, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S_{outer}}^{\prime}\right\}\\
&\mathcal{Q}_{S_2}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(2, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S}^{\prime}\right\},\\
&\mathcal{Q}_{S_3}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(3, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S}^{\prime}\right\}.
%\\
%&\mathcal{Q}_{S_{4}}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(4, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S_{outer}}^{\prime}\right\}
\end{aligned}
$$
%
In words, $\mathcal{Q}_{S_{i}}^{(1)}$ summarizes each constraint that is forced on $S_{i}$ by $\mathcal{Q}_{S}$ and $\mathcal{Q}_{S}^{\prime}$. Let        {\small
%
$$
\begin{aligned}
%&U_{1}=\left\{u_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(1)}\right\}, \quad V_{1}=\left\{v_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(1)}\right\},\\
&U_2^{(1)}=\left\{u_2 \in\{0,1\}^{n}:\left(2, u_2, v_2\right) \in \mathcal{Q}_{S_2}^{(1)}\right\}, \quad V_2^{(1)}=\left\{v_2 \in\{0,1\}^{n}:\left(2, u_2, v_2\right) \in \mathcal{Q}_{S_2}^{(1)}\right\},\\
&U_3^{(1)}=\left\{u_3 \in\{0,1\}^{n}:\left(3, u_3, v_3\right) \in \mathcal{Q}_{S_3}^{(1)}\right\}, \quad V_3^{(1)}=\left\{v_3 \in\{0,1\}^{n}:\left(3, u_3, v_3\right) \in \mathcal{Q}_{S_3}^{(1)}\right\}.
%\\
%&U_{4}=\left\{u_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(1)}\right\}, \quad V_{4}=\left\{v_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(1)}\right\}
\end{aligned}
$$
}%
%
be the domains and ranges of $\mathcal{Q}_{S_2}^{(1)}$ and $\mathcal{Q}_{S_3}^{(1)}$ respectively.




\begin{definition}
\label{defn:bad-tau-4-rounds}

We say an extended transcript $\tau^{\prime}$ is bad if at least one of the following conditions is fulfilled. The conditions are classified into two categories depending on the relevant randomness. In detail, regarding $k_0,k_1,k_3,k_4$:
\begin{itemize}[leftmargin=10mm]
	\item[\bone] there exist (not necessarily distinct) $(x,a,b,y),(x',a',b',y'),(x'',a'',b'',y'')\in \mathcal{Q}_{C}'$ and three distinct indices $i, i', i'' \in \{1, \ldots, w\}$ such that:
	\begin{itemize}
		\item $(x\xor k_0)[i]=(x'\xor k_0)[i']=(x''\xor k_0)[i'']$, or
		\item $(a\xor k_1)[i]=(a'\xor k_1)[i']=(a''\xor k_1)[i'']$, or
		\item $(b\xor T^{-1}(k_3))[i]=(b'\xor T^{-1}(k_3))[i']=(b''\xor T^{-1}(k_3))[i'']$, or
		\item $(y\xor k_4)[i]=(y'\xor k_4)[i']=(y''\xor k_4)[i'']$.
	\end{itemize}
	\item[\btwo] there exist $(x,a,b,y) \in \mathcal{Q}_{C}'$ and distinct indices $i, i' \in \{1, \ldots, w\}$ such that:
	\begin{itemize}
		\item $(x\xor k_0)[i]\in U_1^{(0)}$ and $(x\xor k_0)[i']\in U_1^{(0)}$, or
		\item $(a \oplus k_1)[i]\in U_{2}^{(0)}$ and $(a \oplus k_1)[i']\in U_{2}^{(0)}$, or
		\item $(b\xor T^{-1}(k_3))[i]\in V_3^{(0)}$ and
		$(b'\xor T^{-1}(k_3))[i']\in V_3^{(0)}$, or
		\item $(y\xor k_4)[i]\in V_4^{(0)}$ and $(y\xor k_4)[i']\in V_4^{(0)}$.
	\end{itemize}
\end{itemize}
%
%
Regarding $k_2,S_1,S_4$, and $\mathcal{Q}_S'$:
%
%
\begin{itemize}[leftmargin=10mm]
	\item[\bthree] there exist $(x,a,b,y) \in \mathcal{Q}_{C}'$ and $i, j\in\{1, \ldots, w\}$ such that:
	\begin{itemize}
		\item $(a\xor k_1)[i]\in U_2^{(1)}$ and $(b\xor T^{-1}(k_3))[j]\in V_3^{(1)}$, or
		\item $(a \oplus k_1)[i]\in U_{2}^{(1)}$ and $(T(\overline{S_2}(a \oplus k_1))\xor k_2)[j]\in U_{3}^{(1)}$, or
		\item $(T^{-1}(\overline{S_3^{-1}}(b\xor T^{-1}(k_3))\xor k_2))[i]\in V_2^{(1)}$ and $(b\xor T^{-1}(k_3))[j]\in V_{3}^{(1)}$.
	\end{itemize}
	\item[\bfour] there exist $(x,a,b,y),(x',a',b',y') \in \mathcal{Q}_{C}'$ and $i, i^{\prime},j, j^{\prime} \in\{1, \ldots, w\}$, $(a,b, j) \neq \left(a^{\prime}, b',j^{\prime}\right)$, such that $(a \oplus k_1)[i]\in U_{2}^{(1)}, (a' \oplus k_1)[i']\in U_{2}^{(1)}$, and
	%
	$$\big(T(\overline{S_2}(a\xor k_1))\xor k_2\big)[j]=\big(T(\overline{S_2}(a'\xor k_1))\xor k_2\big)[j'].
	$$
	%
	\item[\bfive] there exist $(x,a,b,y),(x',a',b',y') \in \mathcal{Q}_{C}'$ and $i, i^{\prime}, j, j^{\prime} \in\{1, \ldots, w\}$, $(a,b, j) \neq \left(a',b^{\prime}, j^{\prime}\right)$, such that $\big(b \oplus T^{-1}(k_3)\big)[i]\in V_{3}^{(1)}, \big(b' \oplus T^{-1}(k_3)\big)[i']\in V_{3}^{(1)}$, and
	%
	$$\big(T^{-1}(\overline{S_3^{-1}}(b \oplus T^{-1}(k_3))\xor k_2)\big)[j]=\big(T^{-1}(\overline{S_3^{-1}}(b' \oplus T^{-1}(k_3))\xor k_2)\big)[j'].
	$$
\end{itemize}
Any extended transcript that is not bad will be called good. Given an original transcript $\tau$, we denote $\Theta_{\mathrm{good}}(\tau)$ (resp. $\Theta_{\mathrm{bad}}(\tau)$) the set of good (resp. bad) extended transcripts of $\tau$ and $\Theta'(\tau)$ the set of all extended transcripts of $\tau$.
\end{definition}



We start by upper bounding the probability of getting bad transcripts in the ideal world.

\begin{lemma}
	\label{lemma:bad-tau-4-rounds}
	
	Assuming $p+wq\leq N/2$, then it holds
	\begin{align}
	{\Pr}\big[\tau^{\prime} \in \Theta_{\mathrm{bad}}(\tau)\big] \leq \frac{5w^2q(p+2wq)^2}{N^2}+
	\frac{3w^4q^2(p+2wq)}{N^2}.
	\label{eq:bound-bad-tau-4-rounds}
	\end{align}
\end{lemma}

The remaining of this subsection is devoted to establish Eq. (\ref{eq:bound-bad-tau-4-rounds}). To this end, we analyze the conditions in turn.



%\subsubsection{\bone, \btwo, and \bthree}
%
%\arrangespace
%
%\noindent \textsc{\bone}.
%
\subsubsection{Conditions \bone and \btwo}

For \bone, consider each of the $q^3w(w-1)(w-2)/3!\leq w^3q^3/6$ choices of $(x,a,b,y),(x',a',b',y')$, $(x'',a'',b'',y'')\in \mathcal{Q}_{C}'$ and distinct $i, i', i'' \in \{1, \ldots, w\}$. Since $k_0[i]$, $k_0[i']$, and $k_0[i'']$ are uniform and independent, the probability to have $(x\xor k_0)[i]=(x'\xor k_0)[i']=(x''\xor k_0)[i'']$ is $1/N^2$. Similarly, the probability to have $(a\xor k_1)[i]=(a'\xor k_1)[i']=(a''\xor k_1)[i'']$, {\it or} $(b\xor k_3)[i]=(b'\xor k_3)[i']=(b''\xor k_3)[i'']$, {\it or} $(y\xor k_4)[i]=(y'\xor k_4)[i']=(y''\xor k_4)[i'']$, is $3/N^2$. Thus
%
$$
\operatorname{Pr}\left[\bone\right] \leq \frac{4w^3q^3}{6N^2}\leq \frac{w^3q^3}{N^2}.
$$
%


		
%\arrangespace

%\noindent \textsc{\btwo}.
%

Regarding \btwo, for each of the $q{w\choose 2}\leq w^2q/2$ choices of $(x,a,b, y) \in \mathcal{Q}_{C}'$ and distinct $i, i' \in \{1, \ldots, w\}$, since $k_0[i]$ and $k_0[i']$ are uniform and independent, the probability to have $(x \oplus k_{0})[i]\in U_1^{(0)}$ and $(x \oplus k_0)[i']\in U_1^{(0)}$ is at most $\big|U_1^{(0)}\big|^2/N^2=p^2/N^2$. The same bound holds for the other three conditions. Thus
%
$$
\operatorname{Pr}\left[\btwo\right] \leq \frac{w^{2} q}{2}\cdot\frac{4p^2}{N^2}\leq\frac{2w^{2} q p^2}{N^{2}}.
$$
%



%Regarding \bthree, for each of the $w^2q$ choices of $(x,a,b,y)\in\mathcal{Q}_{C}'$ and indices $i, j \in \{1, \ldots, w\}$, since $k_{0}$ and $k_1$ are uniform and independent, the probability to have $\left(x \oplus k_{0}\right)[i]\in U_1^{(0)}$ and $\left(a\oplus k_{1}\right)[j]\in U_2^{(0)}$ is $p^2/N^2$. The same bound holds for the other condition. Thus
%%
%$$
%\operatorname{Pr}\left[\bthree\right] \leq \frac{w^{2} q}{2}\cdot\frac{2p^2}{N^2}\leq\frac{w^{2} q p^2}{N^{2}}.
%$$
%




\subsubsection{Useful intermediate results}



To analyze the remaining conditions, we will rely on the following lemma, which characterizes some useful properties of the $t$-th round of the linear SPN.

\begin{lemma}
	\label{lemma:coll-prob}
	
	For any $t\in\{1,2\}$, $r\in\{3,4\}$, $z,z',\delta\in\{0,1\}^n$, and $i,i',j,j'\in\{1,\ldots,w\}$, define
	\begin{align*}
	&\pcoll_{1}^+(t,z,z',j,j')  :={\Pr}\Big[\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[j]=\big(T\big(\overline{S_t}(z'\xor k_{t-1})\big)\xor k_t\big)[j']       \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_t\vdash\mathcal{Q}_{S_t}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_{t-1})[\ell]\notin U_t^{(0)}\Big],         \\
	&\pcoll_{2}^+(t,z,z',i,i',j,j')      :={\Pr}\Big[\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[j]=\big(T\big(\overline{S_t}(z'\xor k_{t-1})\big)\xor k_t\big)[j']   \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_t\vdash\mathcal{Q}_{S_t}^{(0)}\wedge(z\xor k_{t-1})[i]\in U_t^{(0)}\wedge(z'\xor k_{t-1})[i']\in U_t^{(0)}\Big],         \\
	%
	&\pcoll_{3}^+(t,z,i,\delta)      :={\Pr}\Big[\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[i]=\delta    \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_t\vdash\mathcal{Q}_{S_t}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_{t-1})[\ell]\notin U_t^{(0)}\Big],         \\
	%
	&\pcoll_{1}^-(r,z,z',j,j')     :={\Pr}\Big[\big(T^{-1}\big(\overline{S_r^{-1}}(z\xor k_r)\big)\xor k_{r-1}\big)[j]=\big(T^{-1}\big(\overline{S_r^{-1}}(z'\xor k_r)\big)\xor k_{r-1}\big)[j']    \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_r\vdash\mathcal{Q}_{S_r}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_r)[\ell]\notin V_r^{(0)}\Big],         \\
	&\pcoll_{2}^-(r,z,z',i,i',j,j')    :={\Pr}\Big[\big(T^{-1}\big(\overline{S_r^{-1}}(z\xor k_r)\big)\xor k_{r-1}\big)[j]=\big(T^{-1}\big(\overline{S_r^{-1}}(z'\xor k_r)\big)\xor k_{r-1}\big)[j']     \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_r\vdash\mathcal{Q}_{S_r}^{(0)}\wedge(z\xor k_r)[i]\in V_r^{(0)}\wedge(z'\xor k_r)[i']\in V_r^{(0)}\Big],         \\
	%
	&\pcoll_{3}^-(r,z,i,\delta)      :={\Pr}\Big[\big(T^{-1}\big(\overline{S_r^{-1}}(z\xor k_r)\big)\xor k_{r-1}\big)[i]=\delta    \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_r\vdash\mathcal{Q}_{S_r}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_r)[\ell]\notin V_r^{(0)}\Big],
	\end{align*}
	where the probabilities are taken over the random choices of $S_t$, $k_{t-1}$, $k_t$, $S_r$, $k_{r-1}$, and $k_r$. Then, as long as $(z,j)\neq(z',j')$, it holds
	\begin{align}
	&\pcoll_{1}^+(t,z,z',j,j')\leq\frac{1}{N-p-wq},  &\pcoll_{2}^+(t,z,z',i,i',j,j')\leq\frac{1}{N-p-wq},    \notag    \\
	&\pcoll_{1}^-(r,z,z',j,j')\leq\frac{1}{N-p-wq},  &\pcoll_{2}^-(r,z,z',i,i',j,j')\leq\frac{1}{N-p-wq}.    \notag   \\
	&\pcoll_{3}^+(t,z,i,\delta)\leq\frac{1}{N}, 
	&\pcoll_{3}^-(r,z,i,\delta)\leq\frac{1}{N}.    \notag
	\end{align}
\end{lemma}
\begin{proof}
	%Consider the probability to have $T\big(\overline{S_t}(z\xor k)\big)[j]$ equal a constant $\delta$ first. By $\neg\bone$, the exists at most 1 index $i_1$ such that $(x\xor k_0)[i_1]=(x\xor k_0)[1]$. By these, we write
	%%
	%\begin{align*}
	%& (T(\overline{S_1}(x\xor k_0)))[i]       \\
	%= &
	%\Big(t_{i,1}\cdot S_1\big((x\xor k_0)[1]\big)
	%\xor
	%t_{i,i_0}\cdot S_1\big((x\xor k_0)[i_0]\big)\Big)
	%\xor
	%\bigoplus_{2\leq\ell\leq w,\ell\neq i_1}t_{i,\ell}\cdot S_1\big((x\xor k_0)[\ell]\big)     \\
	%= &
	%\Big(\big(t_{i,1}\xor t_{i,i_0}\big)\cdot S_1\big((x\xor k_0)[1]\big)\Big)
	%\xor
	%\bigoplus_{2\leq\ell\leq w,\ell\neq i_1}t_{i,\ell}\cdot S_1\big((x\xor k_0)[\ell]\big)    .
	%\end{align*}
	%%
	%
	%
	%Conditioned on $S_1\vdash\mathcal{Q}_{S_1}^{(0)}$ and on the $w-2$ values $\big\{S_1((x\xor k_0)[i'])\}_{2\leq i'\leq w,i'\neq i_1}$, \textbf{the value of $S_1((x \oplus k_0)[0])$ remains uniform in at least $N-p-wq$ values. Moreover, the coefficient $t_{i,1}\xor t_{i,i_0}$ is non-zero as per our assumption. Therefore,} the probability to have $(a\xor k_1)[i]=(T(\overline{S_1}(x\xor k_0)))[i]\xor k_1[i]$ equal some constant $\delta$ is at most $1/(N-p-wq)$.
	%
	%
	%Similarly, the probability of $(b\xor T^{-1}(k_3))[j]\in U_2^{(1)}$ is at most $1/(N-p-wq)$.
	First, consider $\pcoll_{1}^+(t,z,z',j,j')$. When $j\neq j'$, the probability to have
	$\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[j]=\big(T\big(\overline{S_t}(z'\xor k_{t-1})\big)\xor k_t\big)[j']$ is $1/N\leq 1/(N-p-wq)$, since $k_t[j]$ and $k_t[j']$ are uniform and independent. In the remaining we focus on the case of $j=j'$, which means $z\neq z'$ while $T\big(\overline{S_t}(z\xor k_{t-1})\big)[j]=T\big(\overline{S_t}(z'\xor k_{t-1})\big)[j]$. Note that $z\neq z'$ implies there exists $i_0$ such that $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[i_0]$. By the assumption, $(z\xor k_{t-1})[i_0]\notin U_1^{(0)}$. By construction, we have
	%
	\begin{align*}
	&  T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]       \\
	= &
	\Big(\bigoplus_{1\leq\ell\leq w}t_{j,\ell}\cdot S_t\big((z\xor k_{t-1})[\ell]\big)\Big)\xor
	\Big(\bigoplus_{1\leq\ell\leq w}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)   .
	\end{align*}
	%
	Below we distinguish 3 cases:
	
	
	%
	%\reducespace
	%
	%\subsubsection{Case 1: $(z\xor k_{t-1})[i_0]$ is ``unique'',}
	
	
	
	\paragraph{Case 1: $(z\xor k_{t-1})[i_0]$ is ``unique'',}
	
	i.e., $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[\ell]$ for all $\ell\in\{1,\ldots,w\}$, and $(z\xor k_{t-1})[i_0]\neq(z\xor k_{t-1})[\ell]$ for all $\ell\neq i_0$. Then, conditioned on $S_t\vdash\mathcal{Q}_{S_t}^{(0)}$ and on the $2w-1$ values $\{S_t((z\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_0}\cup\{S_t((z'\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w}$, the value of $S_t\big((z\xor k_{t-1})[i_0]\big)$ remains uniform in {\it at least} $N-p-wq$ possibilities. Moreover, the coefficient $t_{j,i_0}$ is non-zero as per our assumption. Therefore, in this case we have
	%
	\begin{align}
	{\Pr}\big[T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]=0\big]\leq\frac{1}{N-p-wq}.
	\label{eq:bound-eq-B33}
	\end{align}
	%
	
	%
	%\reducespace
	%
	%\reducespace
	%
	%\reducespace
	%
	%\subsubsection{Case 2: $(z\xor k_{t-1})[i_0]=(z\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	\paragraph{Case 2: $(z\xor k_{t-1})[i_0]=(z\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	Then by $\neg\bone$, $(z\xor k_{t-1})[i_0]\neq(z\xor k_{t-1})[\ell]$ and $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[\ell]$ for any $\ell\neq i_0,i_1$. We further distinguish two subcases:
	\begin{itemize}
		\item Subcase 2.1: $(z\xor k_{t-1})[i_1]=(z'\xor k_{t-1})[i_1]$. Then, with the two terms $t_{j,i_1}\cdot S_t\big((z\xor k_{t-1})[i_1]\big)$ and $t_{j,i_1}\cdot S_t\big((z'\xor k_{t-1})[i_1]\big)$ canceled, it can be seen
		%
		\begin{align*}
		&  T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]       \\
		= &
		\Big(\bigoplus_{1\leq\ell\leq w,\ell\neq i_1}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)\xor
		\Big(\bigoplus_{1\leq\ell\leq w,\ell\neq i_1}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)   .
		\end{align*}
		%
		Conditioned on $S_t\vdash\mathcal{Q}_{S_t}^{(0)}$ and on the $2w-3$ values $\{S_t((z'\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_1}\cup\{S_t((z\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_0,\ell\neq i_1}$, the value of $S_t((z\xor k_{t-1})[i_0])$ remains uniform in {\it at least} $N-p-wq$ possibilities. Therefore, in this case Eq. (\ref{eq:bound-eq-B33}) still holds.
		\item Subcase 2.2: $(z\xor k_{t-1})[i_1]\neq(z'\xor k_{t-1})[i_1]$. Then we write
		%
		\begin{align*}
		&  T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]       \\
		= &   \underbrace{\Big(t_{j,i_0}\cdot S_t\big((z\xor k_{t-1})[i_0]\big)
			\xor
			t_{j,i_1}\cdot S_t\big((z\xor k_{t-1})[i_1]\big)\Big)}_{\big(t_{j,i_0}\xor t_{j,i_1}\big)\cdot S_t\big((z\xor k_{t-1})[i_0]\big)}   	\\
		&\hugeindent\xor
		\Big(\bigoplus_{1\leq\ell\leq w}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)    \xor
		\Big(\bigoplus_{\ell\neq i_0,\ell\neq i_1}t_{j,\ell}\cdot S_t\big((z\xor k_{t-1})[\ell]\Big).
		\end{align*}
		%
		Conditioned on $S_t\vdash\mathcal{Q}_{S_t}^{(0)}$ and on the $2w-2$ values $\{S_t((z'\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w}\cup\{S_t((x\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_0,\ell\neq i_1}$, $S_t((z\xor k_{t-1})[i_0])$ remains uniform in at least $N-p-wq$ possibilities. Moreover, the coefficient $t_{j,i_0}\xor t_{j,i_1}$ is non-zero as per our assumption. Therefore, Eq. (\ref{eq:bound-eq-B33}) remains.
	\end{itemize}
	
	
	
	%\reducespace
	%
	%\reducespace
	%
	%\subsubsection{Case 3: $(z\xor k_{t-1})[i_0]=(z'\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	\paragraph{Case 3: $(z\xor k_{t-1})[i_0]=(z'\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	The subcase and discussion are similar to Case 2.
	
	
	
	\arrangespace
	
	
	By the above, in any case, the probability to have $T(\overline{S_t}(z\xor k_{t-1}))[j]=T(\overline{S_t}(z'\xor k_{t-1}))[j]$ is at most $1/(N-p-wq)$, which establishes $\pcoll_{1}^+(t,z,z',j,j')\leq1/(N-p-wq)$. Similarly by symmetry, $\pcoll_{1}^-(r,z,z',j,j')\leq1/(N-p-wq)$.
	
	
	
	
	\arrangespace
	
	
	The analysis of $\pcoll_{2}^+(t,z,z',i,i',j,j')$ bears some resemblance. In particular, we focus on the case of $j=j'$ (and thus $z\neq z'$), as otherwise the uniformness of $k_t[j]$ and $k_t[j']$ is sufficient for $\pcoll_{2}^+(t,z,z',i,i',j,j')=1/N$.
	
	
	First, consider $\pcoll_{2}^+(t,z,z',i,i',j,j)$ with $i\neq i'$. Since $z\neq z'$, there exists $i_0$ such that $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[i_0]$. Then either $i\neq i_0$ or $i'\neq i_0$. Wlog assume $i\neq i_0$. Note that this means $(z\xor k_{t-1})[i]\neq(z'\xor k_{t-1})[i_0]$, as otherwise both $(z\xor k_{t-1})[i]$ and $(z\xor k_{t-1})[i_0]$ fall in $U_1^{(0)}$ and it contradicts $\neg\btwo$. In the same vein as the analysis of $\pcoll_{1}^+(t,z,z',j,j')$, we then distinguish three cases. In detail,
	%
	\begin{itemize}
		\item Case 1: $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[\ell]$ for all $\ell\in\{1,\ldots,w\}$, and $(z\xor k_{t-1})[i_0]\neq(z\xor k_{t-1})[\ell]$ for any $\ell\neq i_0$. Then the analysis is similar to Case 1 in the analysis of $\pcoll_{1}^+(t,z,z',j,j')$.
		\item Case 2: $(z\xor k_{t-1})[i_0]=(z\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$. Then, if $(z\xor k_{t-1})[i_1]=(z'\xor k_{t-1})[i_1]$, then the two terms $t_{j,i_1}\cdot S_t\big((z\xor k_{t-1})[i_1]\big)$ and $t_{j,i_1}\cdot S_t\big((z'\xor k_{t-1})[i_1]\big)$ cancel, and the remaining term $t_{j,i_0}\cdot S_t\big((z\xor k_{t-1})[i_0]\big)$ ensures that the probability is at most $1/(N-p-wq)$; otherwise, the term $(t_{j,i_0}\xor t_{j,i_1})\cdot S_t((z\xor k_{t-1})[i_0])$ ensures that the probability is at most $1/(N-p-wq)$.
		\item Case 3: $(z\xor k_{t-1})[i_0]=(z'\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$. This subcase is similar to Case 2.
	\end{itemize}
	%
	%The remaining discussion resembles the previous one for $\pcoll_{1}^+(t,z,z',j)$, which consists of 3 cases shown in Appendix XXX.
	In all, the uniformness of $S_t((z\xor k_{t-1})[i_0])$ is sufficient to ensure ${\Pr}\big[T(\overline{S_t}(z\xor k_{t-1}))[j]=T(\overline{S_t}(z\xor k_{t-1}))[j]\big]\leq1/(N-p-wq)$.
	
	
	
	\arrangespace
	
	
	Then, consider the case of $i=i'$, i.e., $\pcoll_{2}^+(t,z,z',i,i,j,j)$. Assume that $S_t((z\xor k_{t-1})[i])=u_t$ and $S_t((z'\xor k_{t-1})[i])=u_t'$ for $(u_t,v_t),(u_t',v_t')\in\mathcal{Q}_{S_t}^{(0)}$. Then it holds      {\small
		%
		\begin{align}
		&   T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z\xor k_{t-1}))[j]        \notag   \\
		= &
		(t_{j,i}\cdot v_1)
		\xor
		(t_{j,i}\cdot v_1')
		\xor
		\Big(\bigoplus_{1\leq\ell\leq w,\ell\neq i}t_{j,\ell}\cdot
		\big(S_1((x\xor k_0)[\ell])\xor S_1((x'\xor k_0)[\ell])\big)\Big)    .
		\label{eq:interm-eq-b2}
		\end{align}
	}%
	%
	%
	%
	%Assume that $\overline{S_1}(x\xor k_0)=\bfv_1\|v_1\|\bfv_2$ and
	%$\overline{S_1}(x'\xor k_0)=\bfv_1'\|v_1'\|\bfv_2'$, where $v_1,v_1'\in V_1^{(0)}$. Then the equality $T(\overline{S_1}(x\xor k_0))[j]=T(\overline{S_1}(x'\xor k_0))[j]$ implies
	%
	%\begin{align}
	%\bft_1^*\cdot\bfv_1\xor t^*\cdot v_1\xor\bft_2^*\cdot\bfv_2=\bft_1^*\cdot\bfv_1'\xor t^*\cdot v_1'\xor\bft_2^*\cdot\bfv_2'.
	%\label{eq:interm-eq-b2}
	%\end{align}
	%
	%
	%for two vectors $\bft_1^*,\bft_2^*$ and $t^*\in\{0,1\}^n$.
	Now:
	\begin{itemize}
		\item If $x[\ell]=x'[\ell]$ for any $\ell\neq i$, then $z\neq z'$ implies $v_1\neq v_1'$. In this case, Eq. (\ref{eq:interm-eq-b2}) collapses to $t_{j,i}\cdot v_1=t_{j,i}\cdot v_1'$ which is not possible since $t_{j,i}\neq 0$;
		\item Else, there exists $i_0\neq i$ such that $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[i_0]$. This means $(z'\xor k_{t-1})[i]\notin U_t^{(0)}$ (and thus $(z'\xor k_{t-1})[i]\neq(z\xor k_{t-1})[i_0]$) by $\neg\btwo$. The remaining analysis just follows the previous one for $\pcoll_{1}^+(t,z,z',j)$, establishing that the uniformness of $S_t((z\xor k_{t-1})[i_0])$ is sufficient to ensure that $T(\overline{S_t}(z\xor k_{t-1}))[j]$ equals $T(\overline{S_t}(z\xor k_{t-1}))[j]$ with probability at most $1/(N-p-wq)$.
	\end{itemize}
	Therefore, it still holds $\pcoll_{2}^+(t,z,z',i,i,j,j)\leq1/(N-p-wq)$. All the above cases show that $\pcoll_{2}^+(t,z,z',i,i',j,j')\leq1/(N-p-wq)$ for any parameters. Similarly by symmetry, $\pcoll_{2}^-(r,z,z',i,i',j,j')\leq1/(N-p-wq)$.
	
	
	\arrangespace
	
	
	
	Finally, since $k_t[i]$ is uniform and independent of $k_{t-1}$ and $S_t$, it immediately holds
	$$\pcoll_{3}^+(t,z,i,\delta)=\frac{1}{N}.$$
	Similarly, $\pcoll_{3}^-(r,z,i,\delta)=\frac{1}{N}$. These complete the proof.     \qed
\end{proof}





%\arrangespace

%\noindent \textsc{\bfour and \bfive}.
%

\subsubsection{Conditions \bthree, \bfour, and \bfive}


Regarding \bthree, consider any choice of $(x,a,b,y)$ and $i, j$. Consider the probability to have $(a\xor k_1)[i]\in U_2^{(1)}$ first. Note that this consists of three subevents:
\begin{itemize}
	\item(B-31) $(a\xor k_1)[i]\in U_2^{(0)}$;
	\item(B-32) there exists $(x',a',b',y')\in\mathcal{Q}_{C}'$, and $j'\in\{1,\ldots,w\}$ such that $(x,j)\neq(x',j')$, while $(a\xor k_1)[j]=(a'\xor k_1)[j']$.
\end{itemize}
Since $k_1$ is uniform and independent of $S_1$, it holds $\Pr[\text{(B-31)}]\leq p/N$.


For (B-32), consider each $((x',a',b',y'),j')$ such that $(x,j)\neq(x',j')$, we distinguish three cases.
\begin{itemize}
	\item Case 1: $(x\xor k_0)[\ell]\notin U_1^{(0)}$ for all $\ell\in\{1,\ldots,w\}$. Then we have $\pcoll_{1}^+(1,x,x',j,j')\leq1/(N-p-wq)$ by Lemma \ref{lemma:coll-prob}.
	%
	\item Case 2: there exists $i_1$ such that $(x\xor k_0)[i_1]\in U_1^{(0)}$, though $(x'\xor k_0)[\ell]\notin U_1^{(0)}$ for all $\ell\in\{1,\ldots,w\}$. Then we have $\pcoll_{1}^+(1,x',x,j',j)\leq1/(N-p-wq)$ by Lemma \ref{lemma:coll-prob}.
	%
	\item Case 3: there exists $i_1,i_2$ such that $(x\xor k_0)[i_1]\in U_1^{(0)}$ and $(x'\xor k_0)[i_2]\in U_1^{(0)}$. Then we have  $\pcoll_{2}^+(1,x,x',i_1,i_2,j,j')\leq1/(N-p-wq)$ by Lemma \ref{lemma:coll-prob}.
\end{itemize}
%
Therefore, for any $((x',a',b',y'),j')$, the probability to have $(a\xor k_1)[j]=(a'\xor k_1)[j']$ never exceeds $1/(N-p-wq)$. By this, $\Pr[\text{(B-32)}]\leq wq/(N-p-wq)$. Using $p+wq\leq N/2$, we reach
%
$${\Pr}\big[(a\xor k_1)[i]\in U_2^{(1)}\big]
\leq\Pr[\text{(B-31)}]+\Pr[\text{(B-32)}]\leq
\frac{p}{N}+\frac{wq}{(N-p-wq)}\leq\frac{p+2wq}{N}.$$
%

Via deriving one round further in a similar vein, we reach,
%
$${\Pr}\big[(T(\overline{S_2}(a \oplus k_1))\xor k_2)[j]\in U_{3}^{(1)}\big]\leq\frac{p+2wq}{N},$$
%
and similarly by symmetry,
%
\begin{align*}
&{\Pr}\big[(b\xor T^{-1}(k_3))[j]\in V_3^{(1)}\big]\leq\frac{p+2wq}{N},       \\
&{\Pr}\big[(T^{-1}(\overline{S_3^{-1}}(b\xor T^{-1}(k_3))\xor k_2))[i]\in V_2^{(1)}\big]\leq\frac{p+2wq}{N}.
\end{align*}
%
By this, the probability that \bthree is fulfilled with respect to each choice of $((x,a,b,y),i, j)$ is at most $3(p+2wq)^2/N^2$. As there are at most $w^2q$ choices for $(x,a,b,y)$ and $i, j$, we eventually obtain
%
$$
{\Pr}\big[\bthree\big] \leq \frac{3w^2q(p+2wq)^2}{N^2}.
$$



%\input{discared-argument.tex}




\arrangespace

\noindent\textsc{\bfour and \bfive}. For \bfour, we have
%
\begin{align*}
\Pr[\bfour] 
=   &  \sum_{(x,a,b,y),(x',a',b',y')\in\mathcal{Q}_{C}'}\sum_{i,i',j,j'}\bigg(\underbrace{{\Pr}\big[(a\xor k_1)[i]\in U_2^{(1)}\big]}_{\leq(p+2wq)/N\text{, as argued before}}     \\
& \midindent\times
\underbrace{{\Pr}\big[(a'\xor k_1)[i]\in U_2^{(1)}|(a\xor k_1)[i]\in U_2^{(1)}\big]}_{\leq1}\times\underbrace{\pcoll_{2}^+(2,a,a',i,i',j,j')}_{\leq1/(N-p-wq)}   \bigg)      \\
\leq  &  {wq\choose 2}\cdot w^2\cdot\frac{p+2wq}{N}\cdot\frac{1}{N-p-wq}\leq
\frac{w^4q^2(p+2wq)}{N^2}.
\end{align*}
%

Similarly by symmetry,
%
\begin{align*}
\Pr[\bfive] 
\leq
\frac{w^4q^2(p+2wq)}{N^2}.
\end{align*}




\subsubsection{Summary for bad transcripts}


Summing over the above and using $\frac{w^3q^3}{N^2}\leq\frac{w^4q^2(p+2wq)}{N^2}$ and $\frac{2w^{2} q p^2}{N^{2}}\leq\frac{2w^2q(p+2wq)^2}{N^2}$ yield Eq. (\ref{eq:bound-bad-tau-4-rounds}):
%
\begin{align*}
&  {\Pr}\big[ \tau' \in \Theta_{\text {bad }}(\tau)\big]  \leq \sum_{i=1}^{5}\Pr[\bi]       \\
\leq~  & \frac{w^3q^3}{N^2}+
\frac{2w^{2} q p^2}{N^{2}}+
\frac{3w^2q(p+2wq)^2}{N^2}+
\frac{w^4q^2(p+2wq)}{N^2}+
\frac{w^4q^2(p+2wq)}{N^2}             \\
\leq~  & \frac{5w^2q(p+2wq)^2}{N^2}+
\frac{3w^4q^2(p+2wq)}{N^2}.
\end{align*}
%




%\paragraph{\textsc{The inner two rounds.}}


\subsection{Analyzing Good Transcript Extensions}
\label{sec:good-tau-4-rounds}

We are now ready for the second step of the reasoning. Define
%
$$\calC_{\bfk}^T[\calS](a):=   \overline{S_3}(T(\overline{S_2}(a\xor k_1))\xor k_2)\xor T^{-1}(k_3).$$
%
For any attainable transcript $\tau$, the ideal world probability is easy to calculate:
%
%
\begin{align*}
\mathsf{p}_{1}(\tau)=&\operatorname{Pr}\left[(P,\mathcal{S})\stackrel{\$}{\leftarrow} {\mathsf{Perm}}(wn)\times\mathsf{Perm}(n)^4: (\mathcal{S} \vdash \mathcal{Q}_{S}) \wedge(P \vdash \mathcal{Q}_{C})  \right]		\\
=&\frac{1}{(N^w)_q}\cdot\bigg(\frac{1}{(N)_p}\bigg)^4.
\end{align*}



To reach the real world probability $\mathsf{p}_2(\tau)$, consider any transcript extension $\tau'=(\mathcal{Q}_{C}',\mathcal{Q}_{S},\mathcal{Q}_{S}',S_1^*,S_4^*,\bfk)$ from $\tau$. Denote
%
%
\begin{align}
\mathsf{p}_{\mathrm{re}}(\tau') = & \operatorname{Pr}\Big[\left(\mathbf{k}',\mathcal{S}\right) \stackrel{\$}{\leftarrow} \big(\{0,1\}^{wn}\big)^5 \times \mathsf{Perm}(n)^4:
\Big(\big(S_1=S_1^*\big)\wedge\big(S_4=S_4^*\big)\wedge		\notag 	\\
&\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\big(S_2\vdash\mathcal{Q}_{S_2}^{(1)}\big)\wedge\big(S_3\vdash\mathcal{Q}_{S_3}^{(1)}\big)\wedge\big(\calC_{\bfk'}^T[\calS] \vdash \mathcal{Q}_C'\big)\wedge\big(\bfk'=\bfk\big)\Big)\Big]	 	\notag 	\\
\mathsf{p}_{\mathrm{mid}}(\tau') = & \operatorname{Pr}\Big[\mathcal{S} \stackrel{\$}{\leftarrow}\mathsf{Perm}(n)^4:(\calC_{\bfk}^T[\calS] \vdash \mathcal{Q}_C')~\Big|~
(S_1=S_1^*)\wedge (S_4=S_4^*)\wedge	 	\notag 	\\
&\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent (S_2\vdash\mathcal{Q}_{S_2}^{(1)})\wedge (S_3\vdash\mathcal{Q}_{S_3}^{(1)})\Big].	 	\notag 	
%\label{eq:defn-p-mid}
\end{align}
%
%
%
and let $\alpha_1=|\mathcal{Q}_{S_2}^{(1)}|-|\mathcal{Q}_{S_2}^{(0)}|=|\mathcal{Q}_{S_2}^{(1)}|-p$ and $\alpha_2=|\mathcal{Q}_{S_3}^{(1)}|-p$. With these, we have
%
%
\begin{align*}
\mathsf{p}_2(\tau)=&\operatorname{Pr}\left[\left(\mathbf{k},\mathcal{S}\right) \stackrel{\$}{\leftarrow} \big(\{0,1\}^{wn}\big)^5 \times \mathsf{Perm}(n)^4:\big(\spn_{\bfk}^{T}[\mathcal{S}] \vdash \mathcal{Q}_{C}\big) \wedge \big(\mathcal{S} \vdash \mathcal{Q}_{S}\big)\right]		\\
\geq & \sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)} \mathsf{p}_{\mathrm{re}}(\tau')  
\geq
\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
%
\frac{1}{N^{5w}\big((N)_{N}\big)^2(N)_{p+\alpha_1}(N)_{p+\alpha_2}}\cdot \mathsf{p}_{\mathrm{mid}}(\tau')  .
\end{align*}
%
%
Therefore,
%
%
\begin{align*}
\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}   \geq  &
\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
\frac{(N^w)_q\cdot\big((N)_p\big)^4}{N^{5w}\big((N)_{N}\big)^2(N)_{p+\alpha_1}(N)_{p+\alpha_2}}\cdot \mathsf{p}_{\mathrm{mid}}(\tau')         \\
\geq  &    \min_{\tau' \in \Theta_{\mathrm{good}}(\tau)}\big((N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau')\big)
\underbrace{\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
\frac{1}{N^{5w}\big((N-p)_{N-p}\big)^2(N-p)_{\alpha_1}(N-p)_{\alpha_2}}}_{B} .
\end{align*}



Note that, the exact probability of observing the extended transcript $\tau'$ is
%
%
$$\frac{1}{N^{5w}\big((N-p)_{N-p}\big)^2(N-p)_{\alpha_1}(N-p)_{\alpha_2}},$$
%
since:
%
\begin{itemize}
	\item[1.] sample keys $k_0,\ldots,k_4\in\{0,1\}^{wn}$ uniformly and independently at random;
	\item[2.] sample two random permutations $S_1,S_4$ from $\mathsf{Perm}(n)$ at uniform, such that $S_1\vdash\mathcal{Q}_{S_1}^{(0)},S_4\vdash\mathcal{Q}_{S_4}^{(0)}$.
	\item[3.] choose the partial extension of the S-box queries based on the new collisions $\mathcal{Q}_{S}^{\prime}$ uniformly at random (meaning that each possible $\mathnormal{u}$ or $\mathnormal{v}$ is chosen uniformly at random in the set of its authorized values).
\end{itemize}
%
%
This means the term $B$ captures the probability of good transcript extensions:
%
%
\begin{align}
B=&\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
	\frac{1}{N^{5w}\big((N-p)_{N-p}\big)^2(N-p)_{\alpha_1}(N-p)_{\alpha_2}}  \notag   \\
	=&{\Pr}\big[ \tau' \in \Theta_{\text {good }}(\tau)\big] \geq  1- {\Pr}\big[ \tau' \in \Theta_{\text {bad }}(\tau)\big],   \notag
\end{align}
%
%
which further implies
%
%
\begin{align}
\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}   \geq  {\Pr}\big[ \tau' \in \Theta_{\text {good }}(\tau)\big]\cdot
  \min_{\tau' \in \Theta_{\mathrm{good}}(\tau)}\big((N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau')\big). 
\label{eq:ratio-divide-4-rounds}
\end{align}
%
%


The term $\mathsf{p}_{\mathrm{mid}}(\tau')$ captures the probability that $\calC_{\bfk'}^T[\calS] \vdash \mathcal{Q}_C'$, i.e., the inner two SPN rounds are consistent with the pairs of inputs/outputs $(a,b)$ defined in $\mathcal{Q}_C'$. We appeal to~\cite{EPRINT:CogLee18} to have a concrete bound on $(N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau')$.

\begin{lemma}
	\label{lemma:bound-middle-two-rounds}
	
	Assume $p+wq\leq N/2$, then
	\begin{align}
	(N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau') \geq 1-\frac{q^2}{N^w}-\frac{q(2wp+6w^2q)^2}{N^2}.
	\label{eq:bound-on-epsilon-mid}
	\end{align}
\end{lemma}
\begin{proof}
It can be checked that, the transcript $(\mathcal{Q}_C',\mathcal{Q}_{S_2}^{(1)},\mathcal{Q}_{S_3}^{(1)})$ satisfies exactly the conditions defining a good transcript as per~\cite[page 16]{EPRINT:CogLee18}. Moreover,
the ratio $\mathsf{p}_{\mathrm{mid}}(\tau')/(1/(N^w)_q)$ is exactly the ratio of the probabilities to get $\tau'$ in the real and in the ideal world. The result thus immediately follows from~\cite[Lemma 9]{EPRINT:CogLee18}.             \qed
\end{proof}



%The previous proof is conditioned on $S_{1} \vdash \mathcal{Q}_{S_{1}}, S_{4} \vdash \mathcal{Q}_{S_{4}}$, but $\operatorname{Pr}\left[ \tau_{inner}^{\prime} \in \Theta_{\text {good }}(\tau_{inner})\right]$, we need to consider $S_{1} \vdash \mathcal{Q}_{S_{1}}^{(1)}, S_{4} \vdash \mathcal{Q}_{S_{4}}^{(1)}$. That is the probability $\left(T\left(S_{1}\left(x \oplus k_{0}\right) \oplus k_{1}\right)\right)[i]=u_2$ or $\left(T^{-1}\left(S_{4}^{-1}\left(y \oplus k_{4}\right)\right) \oplus k_{3}\right)[j]=v_3$ hold is at most $\frac{1}{(N-p-w q)}$, so
%
%\begin{equation}
%\begin{aligned}
%\operatorname{Pr}\left[ \tau_{inner}^{\prime} \in \Theta_{\text {good }}(\tau_{inner})\right] \geq 1&- \frac{2 w^{2} q (p+w q)^{2}}{(N-p-w q)} -\frac{2 w^{2} q (p+w q)(p+w q+2 q)}{N \cdot (N-p-w q)}\\
%&- \frac{w^{2} q (p+w q)(p+w q+2 q)}{(N-p-w q)^2} - \frac{2 w^{2} q^{2} (p+w q)}{(N- p- wq)^2}.
%\end{aligned}
%\end{equation}



Gathering Eqs. (\ref{eq:bound-bad-tau-4-rounds}), (\ref{eq:ratio-divide-4-rounds}), and (\ref{eq:bound-on-epsilon-mid}), and using $\frac{q(2wp+6w^2q)^2}{N^2}\leq\frac{4w^2q(p+3wq)^2}{N^2}$, we obtain
%
\begin{align*}
\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}   \geq   & \bigg(1-
%
\frac{5w^2q(p+2wq)^2}{N^2}-
\frac{3w^4q^2(p+2wq)}{N^2}
%
\bigg)\cdot\bigg(1-\frac{q^2}{N^w}-\frac{q(2wp+6w^2q)^2}{N^2}\bigg)     \notag      \\
\geq  &  1-\frac{5w^2q(p+2wq)^2}{N^2}-
\frac{3w^4q^2(p+2wq)}{N^2}-\frac{q^2}{N^w}-\frac{4w^2q(p+3wq)^2}{N^2}     \notag        \\
\geq  &  1-
\frac{3w^4q^2(p+2wq)}{N^2}-\frac{q^2}{N^w}-\frac{9w^2q(p+3wq)^2}{N^2}     \notag   
\end{align*}
%
as claimed in Eq. (\ref{eq:bound-proximity-4-round}).
