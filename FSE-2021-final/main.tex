%\documentclass[journal=tosc,submission,spthm]{iacrtrans}
\documentclass[journal=tosc,final,nohyperref]{iacrtrans}
\usepackage[utf8]{inputenc}
\usepackage{makeidx}
\usepackage{graphicx}
\usepackage{algorithm}
\usepackage{amsmath,amsfonts,amssymb}
\usepackage{amstext}
\usepackage[mathscr]{eucal}
\usepackage{bm}
\usepackage{url}
\usepackage{pifont}
\usepackage{calc}
\usepackage{float}
\usepackage{latexsym}
\usepackage{paralist}
\usepackage{xspace}
\usepackage{cancel}
\usepackage{multicol}
\usepackage{epstopdf}
\usepackage{footmisc}
%\usepackage[table]{xcolor}
\usepackage[utf8]{inputenc}
\usepackage[inline]{enumitem}

\usepackage[misc]{ifsym}

%\definecolor{lgray}{gray}{0.70}
\newcommand{\graybox}[1]{
    \colorlet{currentcolor}{.}
    {\color{lgray}%
    \frame{\color{currentcolor}\,#1\,}}
}
\usepackage{array}
\usepackage{multirow}
\DeclareGraphicsExtensions{.eps,.jpg,.png,.pdf}
\usepackage{amstext}

% \usepackage[pagebackref=false,bookmarks=false]{hyperref}
% \hypersetup{colorlinks=true}
%\pagestyle{plain}
\bibliographystyle{alpha}

\input{macros.tex}
\renewcommand\theenumi{\roman{enumi}}
\renewcommand\labelenumi{(\theenumi)}




\author{Yuan Gao\inst{1,2} \and Chun Guo\inst{1,2,3 \text{(\Letter)}} \and Meiqin Wang\inst{1,2} \and\\Weijia Wang\inst{1,2,3} \and Jiejing Wen\inst{1,2 \text{(\Letter)}} }
\institute{School of Cyber Science and Technology, Shandong University, Qingdao, Shandong, 266237, China, \email{gaoyuanwangan@mail.sdu.edu.cn,chun.guo@sdu.edu.cn,mqwang@sdu.edu.cn,wjwang@sdu.edu.cn,jjwen@sdu.edu.cn} \and
Key Laboratory of Cryptologic Technology and Information Security of Ministry of Education, Shandong University, Qingdao, Shandong, 266237, China,  \and
State Key Laboratory of Information Security (Institute of Information Engineering, Chinese Academy of Sciences, Beijing 100093)}
\title[Beyond-Birthday Security for 4-round Linear SPNs]{Beyond-Birthday-Bound Security for 4-round Linear Substitution-Permutation Networks}



\begin{document}
\input{settings.tosc}

	

\maketitle

\keywords{blockciphers \and substitution-permutation networks \and beyond-birthday-bound}


\begin{abstract}
%\add{If you want to replace:} \replace{Recent works}{Some recent papers}
Recent works of Cogliati et al. (CRYPTO 2018) have initiated provable treatments of Substitution-Permutation Networks (SPNs), one of the most popular approach to construct modern blockciphers. Such theoretical SPN models may employ {\it non-linear} diffusion layers, which enables beyond-birthday-bound provable security. Though, for the model of real world blockciphers, i.e., SPN models with {\it linear diffusion layers}, existing provable results are capped at birthday security up to $2^{n/2}$ adversarial queries, where $n$ is the size of the idealized S-boxes.


In this paper, we overcome this birthday barrier and prove that a 4-round SPN with linear diffusion layers and independent round keys is secure up to $2^{2n/3}$ queries. For this, we identify conditions on the linear layers that are sufficient for such security, which, unsurprisingly, turns out to be slightly stronger than Cogliati et al.'s conditions for birthday security. These provides additional theoretic supports for real world SPN blockciphers.
\end{abstract}




\section{Introduction}
\label{section:Introduction}

Modern blockciphers roughly fall into two classes (with some rare exceptions such as IDEA~\cite{EC:LaiMas90} and KATAN~\cite{CHES:DeCDunKne09}), namely {\it Feistel networks and their generalizations}, and {\it substitution-permutation networks} (SPNs). A Feistel round applies a domain-preserving function on half of the data, and then executes XOR and swap operations. This paradigm may be generalized to using compression functions, expansion functions, and smaller functions. Popular examples include many blockcipher standards such as DES~\cite{DESDesign}, GOST~\cite{GOSTDesign}, and Camellia~\cite{ISOIEC-18033-3:2010}. On the other hand, the latter paradigm SPNs start with a set of public permutations on the set of $n$-bit strings which are called S-boxes. These public permutations are then extended to a keyed permutation on $wn$-bit inputs for some integer $w$ by iterating the following steps:
\begin{enumerate}
	\item[1.] {\it Substitution step}: break down the $wn$-bit state into $w$ disjoint chunks of $n$ bits, and evaluate an S-box on each chunk;
	\item[2.] {\it Permutation step}: apply a keyed permutation to the whole $wn$-bit state (which is also applied to the plaintext before the first round).
\end{enumerate}
%
S-boxes are typically highly non-linear, and, in fact, serve as the only source of non-linearity in many blockciphers. There is no a priori restriction on the (non-)linearity of the {\it Permutation step}, and the use and advantages of non-linear permutations was recently explored~\cite{DBLP:journals/dcc/LiuRL18}. Though, modern blockciphers still tend to use linear or affine mappings for the {\it Permutation step}~\cite{DBLP:reference/crypt/Biryukov11aa}, which involves a simple key-mixing step followed
by an invertible linear or affine transformation. More precisely, their permutation steps are {\it linear} or affine with respect to additions on $\text{GF}(2^n)$, where $n$ is the size of the S-box. Various popular blockciphers including the AES~\cite{AESDesign}, Serpent~\cite{serpentProposal}, and the ISO/IEC lightweight standard PRESENT~\cite{CHES:BKLPPR07} follow this approach. Furthermore, a subset of them using maximum distance separable linear transformations allows for effective provable security against certain types of attacks~\cite{IMA:DaeRij01,AC:PSCYL02,FSE:PSLL03,miles2015substitution,EC:SLGRL16}.
%On the other hand, the {\it Permutation step} could also be {\it non-linear}, on which we will elaborate later.


%From a theoretical point of view, both of the two approaches revolve around the extension of a ``complex'' function or permutation on a small domain to a keyed pseudorandom permutation on a larger domain by iterating several times simple rounds.

%SPNs extend domain more efficiently than Feistel networks, in the sense of $wn$-bit SPN cipher versus the $2n$-bit.


The traditional security notion for blockciphers is (strong) pseudorandomness: for any adversary with reasonable resources, the blockcipher with {\it a random and secret key} should be indistinguishable from a truly random
permutation. Proving such security for concrete blockciphers such as AES
seems out of the reach of current techniques. The usual approach is to idealize some underlying primitives and prove that the high-level structure is sound, in the sense of being a strong pseudorandom permutation (SPRP) or others. Typically, to prove security for Feistel networks, the Feistel round functions are idealized, resulting in schemes such as the seminal Luby-Rackoff model~\cite{DBLP:journals/siamcomp/LubyR88,EC:MauPie03,C:patarin03,C:patarin04,C:HoaRog10,JC:CHKPST16}. To prove security for SPNs, the ``S-boxes'' may be idealized as secret random functions or permutations, leaving the permutation layers as efficient ``non-cryptographic'' functions~\cite{FSE:IwaKur00,miles2015substitution}. In this case, the S-boxes act as the only source of cryptographic hardness, while the permutation layers only supply auxiliary {\it combinatorial} properties. This limits the provable security to the domain-size of the S-boxes, which is unfortunately as small as 8 bits in, e.g., the AES. Consequently, provable results on SPNs do not relate to any concrete SPN-based block ciphers. Instead, they should be viewed as theoretical support for the SPN approach to constructing blockciphers.\footnote{Similar limitation exists in Feistel schemes, though it appears more acceptable, being, e.g., 32 bits in DES.}


Recently, initiated by Dodis et al.~\cite{EC:DSSL16,EPRINT:DKSTZ17}, a series of works investigated a new model of SPNs, in which the S-boxes
are small {\it public} ideal primitives and the permutation layers remain non-cryptographic. In detail, it was~\cite{EC:DSSL16} that for the first time investigated the {\it indifferentiability}~\cite{TCC:MauRenHol04}
of confusion-diffusion networks or keyless SPN models combining public random S-boxes and non-cryptographic permutation layers. It was also~\cite{EC:DSSL16} that for the first time confirmed (in a widely recognized theoretical model) that, the use of non-linear permutation layers ensures more security than linear ones. The SPRP security of {\it keyed} SPN models has to be deferred to later in~\cite{EPRINT:DKSTZ17,C:CDKLST18}. In detail, regarding the (more common) SPN model with linear permutation layers, Dodis et al.~\cite{EPRINT:DKSTZ17} exhibited a chosen-ciphertext boomerang attack against 2 rounds using only 4 queries. On the positive side, they proved that 3 rounds ensure the classical birthday-bound security, i.e., security up to $2^{n/2}$ adversarial queries, where $n$ is the size of the idealized S-boxes. These characterized its SPRP security. To ensure this birthday-bound security, the linear permutation layers shall satisfy a quite mild condition of ``zero-freeness'', meaning that all entries in the matrix representations of the linear permutation layers and their inverses shall be non-zero.



Regarding the SPN model with non-linear permutation layers, Dodis et al.~\cite{EPRINT:DKSTZ17} identified a combinatorial property on the permutations that suffices for security in this case, named blockwise universality. Informally, a keyed permutation $\pi_k$ is blockwise universal if, for any distinct inputs $x,x'$ and any constant $c$, the probability (taken over uniform $k$) of each of the following events is low: (i) a block of $\pi(k,x)$ is equal to a block of $\pi(k,x')$, (ii) two different blocks of $\pi(k,x)$ are equal, (iii) a block of $\pi(k,x)$ is equal to $c$. Using such non-linear permutations, they showed that even one round is already sufficient for birthday-bound. Later, Cogliati and Lee improved this result by: (i) adding {\it tweaks} into the non-linear transformations
to obtain {\it tweakable non-linear SPNs}, and (ii) proving beyond-birthday-bound results~\cite{EPRINT:CogLee18}. They showed that two rounds of such tweakable non-linear SPNs are secure tweakable blockciphers~\cite{JC:LisRivWag11} up to roughly $2^{2n/3}$ adversarial queries. They also provided a (non-tight) asymptotic security bound improving as the number of rounds grows.


%
%\subsection{Linear vs Non-linear Permutation steps}
%
%Modern blockciphers tend to use linear or affine mappings for the {\it Permutation step}~\cite{DBLP:reference/crypt/Biryukov11aa}, which involves a simple key-mixing step followed
%by an invertible linear or affine transformation. More precisely, their permutation steps are {\it linear} or affine with respect to additions on $GF(2^n)$, where $n$ is the size of the S-box. This actually includes all the aforementioned SPN ciphers. A small subset of them using MDS linear transformations allows for effective provable security against certain types of attacks~\cite{IMA:DaeRij01,AC:PSCYL02,FSE:PSLL03,miles2015substitution,EC:SLGRL16}.
%
%
%
%On the other hand, as noticed by Dodis et al.~\cite{EPRINT:DKSSZZ18} (the idea of which might further date back to~\cite{FSE:ChaSar06,C:Halevi07}), the {\it Permutation step} could actually be {\it non-linear}. As mentioned before, the security of such non-linear SPN models goes beyond the birthday barrier with more than 2 rounds. Though, such models have two shortages. First, ... implementing a blockwise universal permutations might be costly, and linear functions $f_i$'s would be highly preferable for obvious efficiency reasons. More importantly, {\it far from realistic}. In fact, the idea of using non-linear transformations in real blockciphers was only recently investigated by Liu et al.~\cite{DBLP:journals/dcc/LiuRL18}.
%
%
%
%Regarding the classical SPN model with linear permutation layers, Dodis et al. has characterized its SPRP security.
%They exhibited attacks against 2 rounds using only 4 queries, and proved $n/2$ birthday security at 3 rounds.
%




\subsection{Our Results}

%In this paper, we ask whether it is possible to come with a tweakable Even-
%Mansour construction achieving both:
%1. a linear mixing of the tweak and the key to the state;
%2. beyond-birthday-bound security.
%We answer positively, by providing a construction with 2n-bit keys and n-bit tweaks.

As briefed before, with more than two rounds, non-linear SPNs could ensure beyond-birthday-bound security. Though, practitioners prefer linear SPNs, the security of which is only proved up to birthday-bound at 3 rounds.
%
%
%In fact, beyond-birthday-bound security of linear SPNs with 3 or more rounds was left as an open question in~\cite{C:CDKLST18}.
%
Observing this gap, we ask whether it is possible to achieve security beyond the birthday barrier with linear SPN structures. For this, we focus on linear SPNs with {\it independent S-boxes} and {\it independent round keys}, and we will focus on the case where $w\geq2$, since, when $w = 1$, we recover the standard Even-Mansour construction that has already been well investigated (see the related works below). For such linear SPNs, we answer our main question positively and prove the first beyond-birthday-bound (BBB) $2n/3$-bit security result on 4 rounds.


Concretely, we first characterize conditions on the linear layers that are sufficient for $2n/3$-bit security. For a linear transformation $T$ to meet this, it has to be ``zero-free'' in the aforementioned sense. In addition, in both $T$ and $T^{-1}$, the sum of every 2 entries from the same row shall be non-zero. Thus, the conditions are slightly stronger than that for birthday-bound, and may be viewed as a second order extension of the aforementioned ``zero-freeness'' condition.
%
%A careful thinking of common proofs for $2n/3$-bit security results indicate that such conditions are somewhat within the expectations.
%

With this, we show that a 4-round linear SPN is beyond-birthday-bound secure, if: (i) 4 independent public random S-boxes are used in the four rounds respectively, and (ii) such a ``second order zero-free'' linear permutation layer is used in every round, and (iii) the round keys are uniform and independent. Our proof employs the H-coefficient technique~\cite{SAC:Patarin08}. Moreover, we prove the notion of {\it point-wise proximity}~\cite{C:HoaTes16}, thus establishing $2n/3$-bit {\it multi-user security} for 4-round linear SPNs as well. We refer to Table \ref{tab:my_label} for the position of our result.


Our proof crucially relies on a technical lemma of Cogliati and Lee~\cite{EPRINT:CogLee18} on two SPN rounds. In some sense, in our 4-round linear SPNs, the 1st and 4th round play similar role as the so-called blockwise universal permutations in the 2-round non-linear SPNs of Cogliati and Lee. The situation somewhat resembles that of tweakable Even-Mansour ciphers~\cite{C:CogLamSeu15,AC:CogSeu15}. See Section \ref{section:security of 4-round SPNs} for details.



\begin{table}[]
    \centering
    \begin{tabular}{l|l|l|l|l}
        \hline
        \textbf{Rounds} & \textbf{S-boxes} & \textbf{Permutation layers} & \textbf{Security}  & \textbf{Ref.}\\
        \hline
        \hline
        1 & 1 public  &  Non-linear  & $n/2$, su TSPRP  & \cite{C:CDKLST18}  \\
        2 & 2 public  &  Non-linear  & $2n/3$, mu TSPRP & \cite{EPRINT:CogLee18}  \\
        $2t$ & $2t$ public  &  Non-linear  & $\frac{tn}{t+1}$, mu TSPRP & \cite{EPRINT:CogLee18}  \\
        \hline
        3 & 3 secret  &  Linear, Serpent-like  & $n/2$, su PRP  & \cite{FSE:IwaKur00}\\
        3 & 1 public  &  Linear, ``zero-free''  & $n/2$, su SPRP  & \cite{EPRINT:DKSTZ17}\\
        $t$ & $t$ secret  &  Linear, ``zero-free''  & $n/3$, su PRF  & \cite{miles2015substitution}\\
        4 & 4 public  &  Linear, ``2nd order zero-free''  & $\mathbf{2n/3}$, {\bf mu SPRP}  & {\bf Sect. \ref{section:security of 4-round SPNs}} \\
        \hline
    \end{tabular}
    \caption{Summary of provable result on SP-Networks. The first column presents the number of rounds in the model. The second column indicates how many S-boxes are used in the model \& whether they are secret or public. Regarding security, PRF, PRP, SPRP, and TSPRP (tweakable strong pseudorandom permutation) indicate the security model, su and mu indicates if it's in the single- or multi-user setting, while the header term indicates the concrete provable bounds. We remark that concrete security was not the focus of~\cite{miles2015substitution}.}
    \label{tab:my_label}
\end{table}




\paragraph{Interpretation.}


We view our result as extending a sound theory for constructing ciphers from small S-boxes and providing additional theoretical support for the SPN approach (particularly for the real world ``linear SPNs''). As mentioned before, the $n$-bit idealized S-boxes are the only cryptographic hardness in the current SPN models with non-cryptographic permutation layers, and this enforces the inherent ``$2^n$ provable barrier''. Neither this $2^n$ bound nor our inferior $2^{2n/3}$ bound (though improved upon $2^{n/2}$ of~\cite{C:CDKLST18}) is meaningful for regular SPN blockciphers, in which very low values of $n$ are typically chosen for the S-boxes. For example, the S-box of the AES is based on the inverse of $\text{GF}(2^8)$, and has $n=8$.
Though, this series of theoretic results should be viewed as important complementary to the more coarse iterated Even-Mansour model~\cite{EC:BKLSST12}.

On the other hand, as provable security (mostly against differential and linear properties) of the ARX ciphers advances, recent works have put forward practical choices of 11-~\cite{DBLP:journals/tosc/16-bit-Sbox} or even 64-bit~\cite{cryptoeprint:2019:1378} bigger S-boxes. The bound becomes more meaningful with such parameters.




\subsection{Other Related Work}


Here we survey some other related works besides the aforementioned ones on SPNs with {\it public} S-boxes~\cite{EC:DSSL16,EPRINT:DKSTZ17,EPRINT:CogLee18,C:CDKLST18}. First, when $w=1$,
%
\begin{itemize}
	\item Linear SPNs collapse to the iterated Even-Mansour construction, the SPRP security of which was first studied in~\cite{JC:EveMan97} and subsequently extended to multiple rounds~\cite{EC:BKLSST12,EPRINT:Steinberger12,AC:LamPatSeu12,EC:CheSte14,JC:CLLSS18,C:HoaTes16} and multi-user setting~\cite{C:HoaTes16}. In detail, with $t$ rounds, the $n$-bit iterated Even-Mansour cipher is tightly secure up to $2^{\frac{tn}{t+1}}$ adversarial queries~\cite{EC:BKLSST12,EC:CheSte14,C:HoaTes16};
	\item Non-linear tweakable SPNs collapse to {\it tweakable Even-Mansour ciphers} with non-linear tweaking functions~\cite{C:CogLamSeu15} (with follow-ups such as~\cite{AC:CogSeu15,EC:GJMN16,C:Mennink16}).
\end{itemize}
%
Provable security of the earlier non-linear SPN models with {\it secret, key-dependent S-boxes} were (partly) addressed by Naor and Reingold~\cite{JC:NaoRei99}, Chakraborty and Sarkar~\cite{FSE:ChaSar06}, and Halevi~\cite{C:Halevi07}. Security of linear SPN models with such secret S-boxes were proved by Iwata and Kurosawa~\cite{FSE:IwaKur00}, though for specific permutation layers and birthday-bound security only. Subsequently, Miles and Viola~\cite{miles2015substitution} proved chosen-plaintext security for linear SPNs with PRF S-boxes, ``zero-free'' permutations, and more than 2 rounds.


Finally, on the cryptanalytic side, attacks against SPNs could be found in~\cite{EC:Joux03,RSA:HalRog04,JC:BirSha10,AC:BirBouKho14,cryptoeprint:2015:646,cryptoeprint:2015:646}, while provable security has been addressed by~\cite{IMA:DaeRij01,AC:PSCYL02,FSE:PSLL03,miles2015substitution} against differential/linear cryptanalysis and~\cite{EC:SLGRL16} against others such as impossible differential attacks, etc. In addition, it was shown in~\cite{DBLP:journals/dcc/LiuRL18} that the use of non-linear permutation layers may indeed increase security against differential/linear attacks.


\floatstyle{boxed}
\restylefloat{figure}





\section{Preliminaries}
\label{sec:preliminary}

Throughout this work, we fix positive integers $w$ and $n$, and let $N=2^n$. Let $\mathbb{F}:=\text{GF}(2^n)$, which is identified with $\{0,1\}^n$. An element $x$ in $\{0,1\}^{wn}$ can be viewed as a concatenation of $w$ blocks of length $n$. The $i$th block of this representation will be denoted $x[i]$ for $i=1,\ldots,w$, so we have $x=x[1]\|x[2]\|\ldots\|x[w]$. For any integer $r$ such that $r\geq s$, we will write $(r)_s = r!/(r-s)!$, and define $(r)_0:=1$ for completeness. For an integer $m\geq1$, the set of all permutations on $\{0, 1\}^m$ will be denoted $\textsf{Perm}(m)$.




%\arrangespace
%\medskip
%\noindent{\bf Linear Substitution-Permutation Networks.}
%


\paragraph{Linear substitution-permutation networks.}

A {\it substitution-permutation network} (SPN) defines a keyed permutation via repeated invocation of two transformations: blockwise computation of a public, cryptographic permutation called an ``S-box,'' and application of a keyed, non-cryptographic permutation. In this paper we will only introduce a model of linear SPNs.
%Formally, let $\calK$ be a
%set.
%
%The $r$-round tweakable Even-Mansour construction TEM[n, r, f] specifies, from an r-tuple P = (P1, . . . , Pr)
%of permutations of {0, 1}n, a tweakable block cipher with key space K, tweak space T , and
%message space {0, 1}n, simply denoted TEMP in the following (parameters [n, r, f] will always
%be clear from the context) which maps a key k 2 K, a tweak t 2 T , and a plaintext x 2 {0, 1}n
%to the ciphertext defined as (see Figure 1):
%
Formally, an $r$-round SPN taking inputs of length $w n$ is defined by $r+1$ round keys $\bfk=(k_0,k_1,\ldots,k_r)\in(\{0,1\}^{wn})^{r+1}$, $r$ permutations $S_1,\ldots,S_r:\{0,1\}^{n} \rightarrow \{0,1\}^{n}$, and an invertible linear permutation $T\in\mathbb{F}^{w\times w}$. Define
%
%
$$\overline{S_i}(x[1]\xor k_{i-1}[1]\|\ldots\| x[w]\xor k_{i-1}[w]) \stackrel{\text { def }}{=} S_i(x[1]\xor k_{i-1}[1])\|\ldots\| S_i(x[w]\xor k_{i-1}[w]).$$
%
%
Then, given an input $x \in \{0,1\}^{w n}$, the output of the SPN $\spn_{\bfk}^T[\mathcal{S}]$ is computed as follows:

\begin{itemize}
	\item[--]
	Let $x_1 := x$.
	\item[--]
	For $i = 1$ to $r-1$ do:
	\begin{itemize}
		\item[1.] $y_{i} := \overline{S_i}(x_{i}\xor k_{i-1})$.
		\item[2.] 
		$x_{i + 1} := T\cdot y_i$.
	\end{itemize}
	\item[--] $x_{r+1} := \overline{S_r}(x_r\xor k_{r-1})\xor k_r$.
	\item[--]
	The output is $x_{r+1}$.
\end{itemize}

Note that this model matches the structure of popular SPN ciphers such as the AES, Serpent, and PRESENT. Also note that our model follows~\cite[Sect. 4.2]{C:CDKLST18} and uses different S-boxes in different rounds. We remark that some other~\cite[Sect. 3]{C:CDKLST18} assumed the same S-box in every round. Finally, we refer to~\cite[Sect. 2.1]{EPRINT:DKSTZ17} for a more general model of SPNs and its connection to the above model.


%We will mostly be interested in the case where
%K = ({0, 1}n)a and T = ({0, 1}n)b for
%integers a, b  1. In this setting, we will denote k = (k0, . . . , ka−1) and t = (t0, . . . , tb−1), all
%ki’s and tj ’s being n-bit strings, or simply k = k, resp. t = t when a = 1, resp. b = 1. When all
%fi’s are linear over ({0, 1}n)a+b,
%we say that the construction has linear tweak and key mixing.








%\arrangespace

%\medskip
%\noindent{\bf Multi-user Security Definitions.}
%

\paragraph{Multi-user security definitions.}


Let $\spn^T[\mathcal{S}]$ be an $r$-round linear SPN based on a set of S-boxes $\mathcal{S}=(S_1, \ldots  ,S_r)$ and an invertible linear permutation $T$. So $\spn^T[\mathcal{S}]$
becomes a keyed permutation on $\{0, 1\}^{wn}$ with key space $(\{0,1\}^{wn})^{r+1}$.


In the multi-user setting, let $\ell$ denote the number of users. In the real
world, $\ell$ secret keys $\bfk_1,\ldots,\bfk_\ell\in(\{0,1\}^{wn})^{r+1}$ are chosen independently at random.
A set of independent S-boxes $\mathcal{S}=(S_1,\ldots,S_r)$ is also randomly chosen from $\textsf{Perm}(n)^r$. A distinguisher \dis is given oracle access to $(\spn_{\bfk_1}^T[\mathcal{S}],\ldots,\spn_{\bfk_\ell}^T[\mathcal{S}])$ as
well as $\mathcal{S}=(S_1,\ldots,S_r)$. In the ideal world, \dis is given a set of independent
random permutations ${\calP}=({P}_1,\ldots,{P}_{\ell})\in{\operatorname{Perm}}(wn)^\ell$ instead of $(\spn_{\bfk_1}^T[\mathcal{S}],\ldots,\spn_{\bfk_\ell}^T[\mathcal{S}])$. Oracle access to $\mathcal{S}=(S_1,\ldots,S_r)$ is still allowed in this world.


The adversarial goal is to tell apart the two worlds $(\spn_{\bfk_1}^T[\mathcal{S}],\ldots,\spn_{\bfk_\ell}^T[\mathcal{S}],\mathcal{S})$ and $({P}_1,\ldots,{P}_{\ell},\mathcal{S})$ by adaptively making forward and backward queries to each
of the constructions and the S-boxes. Formally, $\dis$'s distinguishing advantage is
defined by
%
$$
\begin{aligned}
\operatorname{Adv}_{\spn^T}^{\mathrm{mu}}(\mathcal{D}) &=\operatorname{Pr}\left[{P}_1,\ldots,{P}_{\ell} \stackrel{\$}{\leftarrow} {\mathsf{Perm}}(w n)^\ell, \mathcal{S} \stackrel{\$}{\leftarrow} \mathsf{Perm}(n)^{r}: 1 \leftarrow \mathcal{D}^{\mathcal{S}, {P}_{1}, \ldots, {P}_{\ell}}\right] \\
&-\operatorname{Pr}\left[\mathbf{k}_{1}, \ldots, \mathbf{k}_{\ell} \stackrel{\$}{\leftarrow} \big((\{0,1\}^{wn})^{r+1}\big)^{\ell}, \mathcal{S} \stackrel{\$}{\leftarrow} \operatorname{Perm}(n)^{r}: 1 \leftarrow \mathcal{D}^{\mathcal{S}, \spn_{\mathbf{k}_{1}}^T[\mathcal{S}], \ldots, \spn_{\mathbf{k}_{\ell}}^T[\mathcal{S}]}\right].
\end{aligned}
$$
%
For $p,q > 0$, we define
%
$$
\operatorname{Adv}^{\mathrm{mu}}_{\spn^T}(p, q) = \max _{\mathcal{D}} \operatorname{Adv}^{\mathrm{mu}}_{\spn^T}(\mathcal{D})
$$
%
where the maximum is taken over all adversaries $\mathcal{D}$ making at most $\mathnormal{p}$ queries to each of the S-boxes and at most $\mathnormal{q}$ queries to the $\ell$ outer permutations in total (thus $\ell\leq q$). In the single-user setting with $\ell = 1$, $\operatorname{Adv}^{\mathrm{mu}}_{\spn^T}(\mathcal{D})$ and $\operatorname{Adv}^{\mathrm{mu}}_{\spn^T}(p, q)$  will also be written as $\operatorname{Adv}^{\mathrm{su}}_{\spn^T}(\mathcal{D})$ and $\operatorname{Adv}^{\mathrm{su}}_{\spn^T}(p, q)$, respectively.





%\arrangespace

%\medskip
%\noindent{\bf The H-coefficient Technique.}
%

\paragraph{The H-coefficient technique.}

Suppose that a distinguisher $\mathcal{D}$ makes $\mathnormal{p}$ queries to each of the S-boxes, and in total $\mathnormal{q}$ queries to the construction oracles. The queries made to the $j$-th construction oracle, denoted $C_j$, are recorded in a query history
%
\begin{align}
\mathcal{Q}_{C_j} = (j,x_{j,i},y_{j,i})_{1 \leq i \leq q_j}
\label{eq:defn-QC}
\end{align}
%
for $j=1,...,\ell$, where $q_j$ is the number of queries made to $C_j$ and $(j,x_{j,i},y_{j,i})$ represents the evaluation obtained by the $i$th query to $C_j$. So according to the instantiation, it implies either $\spn_{\bfk_j}^T[\mathcal{S}](x_{j,i}) = y_{j,i}$  or ${P}_j(x_{j,i}) = y_{j,i}$. Let
%
$$\mathcal{Q}_{C}=\mathcal{Q}_{C_1}\cup\ldots\cup\mathcal{Q}_{C_\ell}.$$
%
For $j = 1,\ldots,r$, the queries made to $S_j$ are recorded in a query history
%
$$
\mathcal{Q}_{S_j} = (j, u_{j,i}, v_{j,i})_{1 \leq i \leq p}
$$
%
where $(j, u_{j,i}, v_{j,i})$  represents the evaluation $S_j(u_{j,i}) = v_{j,i}$ obtained by the $\mathnormal{i}$th query to $S_j$. Let
%
$$
\mathcal{Q}_{S}=\mathcal{Q}_{S_1} \cup \ldots \cup \mathcal{Q}_{S_r}
$$
%
Then the pair of query histories
%
$$
\tau = (\mathcal{Q}_{C}, \mathcal{Q}_{S})
$$
%
will be called the transcript of the attack: it contains all the information that $\mathcal{D}$ has obtained at the end of the attack. In this work, we will only consider
information theoretic distinguishers. Therefore we can assume that a distinguisher is deterministic and does not make any redundant query, and hence the output of  $\mathcal{D}$  can be regarded as a function of $\tau$, denoted $\mathcal{D}(\tau)$ or $\mathcal{D}(\mathcal{Q}_C, \mathcal{Q}_S)$.





Fix a transcript $\tau = (\mathcal{Q}_C,\mathcal{Q}_S)$, a key $\bfk \in(\{0,1\}^{wn})^{r+1}$, a permutation ${P} \in {\mathsf{Perm}}(wn)$,  a set of S-boxes $\mathcal{S}=(S_1, \ldots  ,S_r) \in \mathsf{Perm}(n)^r $ and $j \in \{1, \ldots, \ell \}$: if $S_j(u_{j,i})=v_{j,i}$ for every $i = 1, . . . , p$, then we will write $S_j\vdash\mathcal{Q}_{S_j}$. We will write $\mathcal{S}\vdash\mathcal{Q}_S$ if $S_j\vdash\mathcal{Q}_{S_j}$ for every $j = 1, . . . , r$. Similarly, if
$\spn_{\bfk}^T[\mathcal{S}](x_{j,i}) = y_{j,i}$ (resp. ${P}(x_{j,i}) = y_{j,i}$) for every $i = 1, . . . , q_j$, then we will write $\spn_{\bfk}^T[\mathcal{S}]\vdash\mathcal{Q}_{C_j}$ (resp. ${P}\vdash\mathcal{Q}_{C_j}$).


Let $\bfk_1, \ldots ,\bfk_{\ell} \in \big((\{0,1\}^{wn})^{r+1}\big)^{\ell}$ and ${\mathcal{P}} = ({P}_1, \ldots ,{P}_\ell) \in {\mathsf{Perm}}(wn)^\ell$, if $\spn_{\bfk_j}^T[\mathcal{S}]\vdash\mathcal{Q}_{C_j}$ (resp. ${P}_j\vdash\mathcal{Q}_{C_j}$) for every $j = 1, \ldots ,\ell$, then we will write $(\spn_{\bfk_j}^{T}[\mathcal{S}])_{j = 1, \ldots ,\ell} \vdash \mathcal{Q}_C$ (resp. ${P}\vdash\mathcal{Q}_{C}$).
%
If there exist ${\mathcal{P}} \in {\mathsf{Perm}}(wn)^\ell$ and $\mathcal{S} \in \mathsf{Perm}(\emph{n})^r$ that outputs $\tau$ at the end of the interaction with $\mathcal{D}$, then we will call the transcript $\tau$ attainable. So for any attainable transcript $\tau= (\mathcal{Q}_C,\mathcal{Q}_S)$, there exist ${\mathcal{P}} \in {\mathsf{Perm}}(wn)^\ell$ and $\mathcal{S} \in \mathsf{Perm}(n)^r$ such that ${\mathcal{P}}\vdash\mathcal{Q}_C$ and $\mathcal{S}\vdash\mathcal{Q}_S$. For an attainable transcript $\tau = (\mathcal{Q}_C,\mathcal{Q}_S)$, let
%
%
$$
\begin{aligned}
&\mathsf{p}_{1}(\tau)=\operatorname{Pr}\left[{\mathcal{P}} \stackrel{\$}{\leftarrow} {{\mathsf{Perm}}}(wn)^{\ell}, \mathcal{S} \stackrel{\$}{\leftarrow} \mathsf{Perm}(n)^{r}: {\mathcal{P}} \vdash \mathcal{Q}_{C} \bigwedge \mathcal{S} \vdash \mathcal{Q}_{S}\right],\\
&\mathsf{p}_{2}(\tau)=\operatorname{Pr}\left[\bfk_{1}, \ldots, \bfk_{\ell} \stackrel{\$}{\leftarrow} \big((\{0,1\}^{wn})^{r+1}\big)^{\ell}, \mathcal{S} \stackrel{\$}{\leftarrow} \mathsf{Perm}(n)^{r}:(\spn_{\bfk_{j}}^{T}[\mathcal{S}])_{j} \vdash \mathcal{Q}_{C} \bigwedge \mathcal{S} \vdash \mathcal{Q}_{S}\right].
\end{aligned}
$$
%
%
With these definitions, the core lemma of the H-coefficient technique (without defining ``bad'' transcripts) is stated as follows.


\begin{lemma}
	\label{lemma:h-coeff}
	
	Let $\varepsilon \geq 0$. Suppose that for any attainable transcript $\tau = (\mathcal{Q}_C,\mathcal{Q}_S)$,
	\begin{align}
	\mathsf{p}_{2}(\tau) \geq (1 - \varepsilon) \mathsf{p}_{1}(\tau).
	\label{eq:h-ratio}
	\end{align}
	Then one has
	$$
	\operatorname{Adv}^{\mathrm{mu}}_{\spn^T}(\mathcal{D}) \leq \varepsilon.
	$$
\end{lemma}
%
%
The lower bound (\ref{eq:h-ratio}) is called {\it $\varepsilon$-point-wise proximity} of the transcript $\tau = (\mathcal{Q}_C, \mathcal{Q}_S)$. The point-wise proximity of a transcript in the multi-user setting is guaranteed by the point-wise proximity of $(\mathcal{Q}_{C_{j}}, \mathcal{Q}_S)$ for each $j = 1, \ldots ,\ell$ in the single user setting. The following lemma is a restatement of Lemma 3 in~\cite{C:HoaTes16}.


\begin{lemma}
	\label{lemma:point-wise}
	
	Let $\varepsilon : \mathbb{N} \times \mathbb{N} \rightarrow \mathbb{R}^{\geq 0}$ be a function such that
	\begin{itemize}
		\item[1.] $\varepsilon (x, y) + \varepsilon (x, z) \leq \varepsilon (x, y + z)$ for every $x, y, z \in \mathbb{N}$,
		\item[2.] $\varepsilon (\cdot, z)$ and $\varepsilon (z, \cdot)$ are non-decreasing functions on $\mathbb{N}$ for every $z \in \mathbb{N}$.
	\end{itemize}
	Suppose that for any distinguisher $\mathcal{D}$ in the {\it single-user setting} that makes p primitive queries to each of the underlying S-boxes and makes q construction queries, and for any attainable transcript $\tau$ obtained by $\mathcal{D}$, one has
	%
	$$
	\mathsf{p}_{2}(\tau) \geq (1 - \varepsilon(p,q)) \mathsf{p}_{1}(\tau).
	$$
	%
	Then for any distinguisher $\mathcal{D}$ in the {\it multi-user setting} that makes $\mathnormal{p}$ primitive queries to each of the underlying S-boxes and makes total $\mathnormal{q}$ construction queries, and for any attainable transcript $\tau$ obtained by $\mathcal{D}$, one has
	%
	$$
	\mathsf{p}_{2}(\tau) \geq (1 - 2 \varepsilon(p + wq,q)) \mathsf{p}_{1}(\tau).
	$$
\end{lemma}



%
%For any extended transcript $\tau^{\prime} = (\mathcal{Q}_C, \mathcal{Q}_S, \mathcal{Q}_S^{\prime},k)$, where $\mathcal{Q}_{S}^{(1)} = \mathcal{Q}_S \cup \mathcal{Q}_S^{\prime}$, denote
%
%$$
%\mathrm{p}\left(\tau^{\prime}\right)=\operatorname{Pr}\left[\mathcal{S} \stackrel{\mathrm{s}}{\leftarrow} \operatorname{Perm}(n)^{2}: \mathrm{\operatorname{SP}}^{T}_{k}[\mathcal{S}] \vdash \mathcal{Q}_{C} |\left(S_{1} \vdash \mathcal{Q}_{S_{1}}^{(1)}\right) \wedge\left(S_{2} \vdash \mathcal{Q}_{S_{2}}^{(1)}\right)\right].
%$$
%
%Then we will get the following lemma:
%
%\begin{lemma}
%\label{lemma:ratio-2-rounds}
%
%For any good extended transcript $\tau^{\prime}$, one has
%$$
%\left(2^{w n}\right)_{q} \mathrm{p}\left(\tau^{\prime}\right) \geq 1-\frac{q^{2}}{2^{w n}}-\frac{q\left(2 w p+6 w^{2} q\right)^{2}}{2^{2 n}}.
%$$
%\end{lemma}
%






\section{Beyond-Birthday-Bound Security for 4-Round SPNs}
\label{section:security of 4-round SPNs}

%In this section, we prove beyond-birthday-bound SPRP security for 4-round linear SPNs.
Concretely, let $\spn_{\bfk}^T[\mathcal{S}]$ be the 4-round SPN using any linear transformations $T$. I.e.,
%
\begin{align}
\spn_{\bfk}^T[\mathcal{S}](x):=
\xor_{k_4}\circ\overline{S_4}\circ
\xor_{k_3}\circ T\circ\overline{S_3}\circ
\xor_{k_2}\circ T\circ\overline{S_2}\circ
\xor_{k_1}\circ T\circ\overline{S_1}\circ
\xor_{k_0}(x),
%\spn_{\bfk}^T[\mathcal{S}](x):=k_4\xor\overline{S_4}(k_3\xor T(\overline{S_3}(k_2\xor T(\overline{S_2}(k_1\xor T(\overline{S_1}(k_0\xor x))))))).
\label{eq:defn-4-round-spn}
\end{align}
%
where $\xor_{k_i}$ is the operation of xoring with the $wn$-bit round-key $k_i$, and $\circ$ stands for function composition. We define good linear transformations to characterize their properties that are sufficient for $2n/3$-bit security.


\begin{definition}
	\label{defn:good-T}
	
	We say that a linear transformation
	%
	\[
	T=
	\left(
	\begin{array}{cccc}
	t_{1,1}~ & ~t_{1,2}~ & ~\cdots~ & ~t_{1,w}  \\
	t_{2,1}~ & ~t_{2,2}~ & ~\cdots~ & ~t_{2,w}  \\
	\vdots~   & ~\vdots~  &~\ddots~ & ~\vdots   \\
	t_{w,1}~ & ~t_{w,2}~ & ~\cdots~ & ~t_{w,w}  
	\end{array}
	\right),\ \ \ \ \ \ \ 
	T^{-1}=
	\left(
	\begin{array}{cccc}
	t_{1,1}'~ & ~t_{1,2}'~ & ~\cdots~ & ~t_{1,w}'  \\
	t_{2,1}'~ & ~t_{2,2}'~ & ~\cdots~ & ~t_{2,w}'  \\
	\vdots~   & ~\vdots~  &~\ddots~ & ~\vdots   \\
	t_{w,1}'~ & ~t_{w,2}'~ & ~\cdots~ & ~t_{w,w}'  
	\end{array}
	\right),
	\]
	%
	is {\it good}, if:
	\begin{enumerate}
		\item[1.] $T$ contains no zero entries, i.e., $t_{i,j}\neq 0$ for all $i,j\in\{1,\ldots,w\}$, and
		\item[2.] No row of $T$ contains redundant entries, i.e., for every $i$, $t_{i,j}\neq t_{i,j'}$ for all distinct indices $j,j'\in\{1,\ldots,w\}$; and
		\item[3.] $T^{-1}$ contains no zero entries, i.e., $t_{i,j}'\neq 0$ for all $i,j\in\{1,\ldots,w\}$, and
		\item[4.] No row of $T^{-1}$ contains redundant entries, i.e., for every $i$, $t_{i,j}'\neq t_{i,j'}'$ for all distinct indices $j,j'\in\{1,\ldots,w\}$.
	\end{enumerate}
\end{definition}
%
The 1st and 3rd conditions are also required for the birthday security of 3-round linear SPNs~\cite[Sect. 3]{EPRINT:DKSTZ17}. As mentioned in the Introduction, the 2nd and 4th conditions can be seen as a ``second order'' extension of the 1st and 3rd ones. To justify the soundness of this definition, we list several candidates in Appendix \ref{sec:candidates-good-linear}. Using such a good linear transformation $T$ and uniform and independent round keys, $\spn^T$ is beyond-birthday-bound secure.

%We show that $\spn^T$ is an SPRP as long as: (i) the linear layer $T$ is good as per Definition \ref{defn:good-T}, and (ii) the round keys $k_0,k_1,k_2,k_3,k_4$ are uniform and independent.

\begin{theorem}
	\label{theorem:4-round-spn}
	
	Assume $w\geq2$, and $p+wq\leq N/2$. Let $\spn_{\bfk}^T[\mathcal{S}]$ be a 4-round, linear SPN as defined by Eq. (\ref{eq:defn-4-round-spn}). If the round keys $\bfk=(k_0,k_1,k_2,k_3,k_4)$ are uniform and independent, and $T$ is good as per Definition \ref{defn:good-T}, then
	%
	\begin{align}
	\operatorname{Adv}_{\spn^T}^{\mathrm{su}}(p, q) \leq~& 	\frac{3w^4q^2(p+2wq)}{N^2}+\frac{9w^2q(p+3wq)^2}{N^2}+\frac{q^2}{N^w},   
	\notag   \\
	\operatorname{Adv}_{\spn^T}^{\mathrm{mu}}(p, q) \leq~& \frac{6w^4q^2(p+3wq)}{N^2}+\frac{18w^2q(p+4wq)^2}{N^2}+\frac{2q^2}{N^w}.
	\notag
	\end{align}
\end{theorem}
The proof of Theorem \ref{theorem:4-round-spn} relies on the following point-wise proximity result and on Lemmas \ref{lemma:h-coeff} and \ref{lemma:point-wise}.


\begin{lemma}
	\label{lemma:proximity-4-round}
	
	Assume $p+wq\leq N/2$. Let $\dis$ be a distinguisher in the single-user setting that makes $p$ primitive queries to each of $S_1,S_2,S_3$, and $S_4$, and makes $q$ construction queries. Then for any attainable
	transcript $\tau=(\mathcal{Q}_C,\mathcal{Q}_S)$, one has
	\begin{align}
	\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}
	\geq 1-
	\frac{3w^4q^2(p+2wq)}{N^2}-\frac{9w^2q(p+3wq)^2}{N^2}-\frac{q^2}{N^w}.
	\label{eq:bound-proximity-4-round}
	\end{align}
\end{lemma}




\subsection{Terminology, and Outline of the Proof}
\label{sec:proof-sketch-4-rounds}

Throughout the proof, we fix a distinguisher $\mathcal{D}$ as described in the statement and fix an attainable transcript $\tau =\left(\mathcal{Q}_{C}, \mathcal{Q}_{S}\right)$ obtained by $\mathcal{D}$. As we focus on the single-user setting, we drop the user indices from Eq. (\ref{eq:defn-QC}) and assume $\mathcal{Q}_{C} = (x_{i},y_{i})_{1 \leq i \leq q}$. Then, let
%
$$
\begin{aligned}
&\mathcal{Q}_{S_{1}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(1, u, v) \in \mathcal{Q}_{S} \right\},\\
&\mathcal{Q}_{S_{2}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(2, u, v) \in \mathcal{Q}_{S} \right\},\\
&\mathcal{Q}_{S_{3}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(3, u, v) \in \mathcal{Q}_{S} \right\},\\
&\mathcal{Q}_{S_{4}}^{(0)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(4, u, v) \in \mathcal{Q}_{S} \right\}.
\end{aligned}
$$
%
and denote the domains and ranges of $\mathcal{Q}_{S_{1}}^{(0)}, \mathcal{Q}_{S_{2}}^{(0)}, \mathcal{Q}_{S_{3}}^{(0)}, \mathcal{Q}_{S_{4}}^{(0)}$ by        {\small
	%
	\begin{align*}
	&U_{1}^{(0)}=\left\{u_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(0)}\right\}, \quad V_{1}^{(0)}=\left\{v_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(0)}\right\},\\
	&U_{2}^{(0)}=\left\{u_{2} \in\{0,1\}^{n}:\left(2, u_{2}, v_{2}\right) \in \mathcal{Q}_{S_{2}}^{(0)}\right\}, \quad V_{2}^{(0)}=\left\{v_{2} \in\{0,1\}^{n}:\left(2, u_{2}, v_{2}\right) \in \mathcal{Q}_{S_{2}}^{(0)}\right\},\\
	&U_{3}^{(0)}=\left\{u_{3} \in\{0,1\}^{n}:\left(3, u_{3}, v_{3}\right) \in \mathcal{Q}_{S_{3}}^{(0)}\right\}, \quad V_{3}^{(0)}=\left\{v_{3} \in\{0,1\}^{n}:\left(3, u_{3}, v_{3}\right) \in \mathcal{Q}_{S_{3}}^{(0)}\right\},\\
	&U_{4}^{(0)}=\left\{u_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(0)}\right\}, \quad V_{4}^{(0)}=\left\{v_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(0)}\right\}.
	\end{align*}
}%
%



\subsubsection{Extending the transcripts}

Point-wise proximity is usually established by enhancing the transcripts with auxiliary random variables, defining a large enough set of ``good'' randomness, and then, for each choice of a good random variable, lower bounding the probability of observing this transcript. Such random variables typically include the keys, and are usually called good if the adversary cannot use the randomness to follow the path of computation of the encryption/decryption of a query up to a contradiction. To this end, we follow~\cite[Sect. 4.2]{C:CDKLST18} and define an extension of the transcript in order to gather enough information to allow simple definition of bad randomness. Then, instead of summing over the choice of the randomness, we will define an extension of the transcript, that will provide the necessary information, and then sum over every possible good extension. In detail, a transcript $\tau$ is first extended in the following manner:
\begin{itemize}
	\item At the end of the interaction between \dis and the real world $(\mathcal{S},\spn_{\bfk}^T[\mathcal{S}])$, we append $\tau$ with the keys $\bfk=(k_0,k_1,k_2,k_3,k_4)$ and the two random permutations $S_1,S_4$ in use;
	\item At the end of the interaction between \dis and the ideal world $(\mathcal{S},\widetilde{P})$, we append $\tau$ with randomly sampled keys $\bfk=(k_0,k_1,k_2,k_3,k_4)$ and the two random permutations $S_1,S_4$ in use.
\end{itemize}
Note that, in either case, it is equivalent to sampling two new random permutations $S_1,S_4$ such that $S_1\vdash\mathcal{Q}_{S_{1}}$ and $S_4\vdash\mathcal{Q}_{S_4}$ and appending them to $\tau$. With the above, for any $(x,y)\in\mathcal{Q}_C$ we define
%
$$a=T\big(\overline{S_1}\left(x \oplus k_{0}\right)\big),\ \ \  b=T^{-1}\big(\overline{S_{4}^{-1}}\left(y \oplus k_{4}\right)\big).$$
%
This extends the list $\mathcal{Q}_C$ into a list as follows:
%
$$\mathcal{Q}_C'=\big((x_1,a_1,b_1,y_1),\ldots,(x_q,a_q,b_q,y_q)\big).$$
%
With this new list, a colliding query is defined as a construction query $(x,y,a,b)\in\mathcal{Q}_C'$ that fulfills any of the following conditions:
%
\begin{itemize}
	%	\item[1.]
	%	there exist an S-box query $(u,v)\in\mathcal{Q}_{S_2}^{(0)}$ and an integer $i \in\{1, \ldots, w\}$ such that $\left(a \oplus k_1\right)[i]=u$.
	%	\item[2.]
	%	there exist an S-box query $(u,v)\in\mathcal{Q}_{S_3}^{(0)}$ and an integer $i \in\{1, \ldots, w\}$ such that $\left(b \oplus T^{-1}(k_3)\right)[i]=v$.
	\item[1.] there exists an index $i \in\{1, \ldots, w\}$ such that $\left(a \oplus k_1\right)[i]\in U_2^{(0)}$.
	\item[2.] there exists an index $i \in\{1, \ldots, w\}$ such that $\left(b \oplus T^{-1}(k_3)\right)[i]\in V_3^{(0)}$.
	\item[3.] there exist a construction query $\left(x',a^{\prime}, b^{\prime},y'\right) \in \mathcal{Q}_{C}'$ and two indices $i,j \in\{1, \ldots, w\}$ such that $(x, a,i) \neq\left(x^{\prime},a', j\right)$ and $\left(a \oplus k_1\right)[i] = \left(a' \oplus k_1\right)[j]$.
	\item[4.] there exist a construction query $\left(x',a^{\prime}, b^{\prime},y'\right) \in \mathcal{Q}_{C}'$ and two indices $i,j \in\{1, \ldots, w\}$ such that $(x,a, i) \neq\left(x^{\prime},a', j\right)$ and $i \in\{1, \ldots, w\}$ such that $\left(b \oplus T^{-1}(k_3)\right)[i] = \left(b' \oplus T^{-1}(k_3)\right)[j]$.
\end{itemize}
%
%
Now we further introduce a new set $\mathcal{Q}_{S}'$ of S-box evaluations to complete the transcript extension. In detail, for each colliding query $(x,a,b,y)\in\mathcal{Q}_C'$, we will add tuples $\left(2, (a \oplus k_1)[i], v^{\prime}\right)_{1 \leq i \leq w}$ (if $(a, b)$ collides at the input of $S_2$) or $\left(3, u^{\prime}, (b \oplus T^{-1}(k_3))[i]\right)_{1 \leq i \leq w}$ (if $(a, b)$ collides at the output of $S_3$) to $\mathcal{Q}_{S}'$ by lazy sampling $v^{\prime}=S_2((a \oplus k_1)[i])$ or $u^{\prime}=S_3^{-1}((b \oplus T^{-1}(k_3))[i])$, as long as it has not been determined by any existing query in $\mathcal{Q}_S$.


We remark that $S_1,S_4$, and $\mathcal{Q}_{S}'$ are {\it auxiliary variables} rather than something given to the distinguisher at the end of the interaction. The latter paradigm was used in~\cite{EC:CheSte14}, but it appears incompatible with point-wise proximity.



An extended transcript of $\tau$ includes all the above additional information, i.e.,
%
$$\tau'=(\mathcal{Q}_{C}',\mathcal{Q}_{S},\mathcal{Q}_{S}',S_1,S_4,\bfk).$$
%
For each collision between a construction query and a primitive query, or between two construction queries, the extended transcript will contain enough information to compute a complete round of the evaluation of the SPN. This will be useful to lower bound the probability to get the transcript $\tau$ in the real world.


Below in Sect. \ref{sec:bad-tau-4-rounds}, we will show that the number of bad extended transcripts is small enough; then in Sect. \ref{sec:good-tau-4-rounds}, we show that the probability to obtain good extension in the real world is sufficiently close to that in the ideal world. These will complete the proof.




\subsection{Bad Transcript Extensions and Probability}
\label{sec:bad-tau-4-rounds}

The first step is to define the set of bad extended transcripts. Consider an attainable extended transcript $\tau'=(\mathcal{Q}_{C}',\mathcal{Q}_{S},\mathcal{Q}_{S}',S_1,S_4,\bfk)$. Let
%
$$
\begin{aligned}
%&\mathcal{Q}_{S_{1}}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(1, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S_{outer}}^{\prime}\right\}\\
&\mathcal{Q}_{S_2}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(2, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S}^{\prime}\right\},\\
&\mathcal{Q}_{S_3}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(3, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S}^{\prime}\right\}.
%\\
%&\mathcal{Q}_{S_{4}}^{(1)}=\left\{(u, v) \in\{0,1\}^{n} \times\{0,1\}^{n}:(4, u, v) \in \mathcal{Q}_{S} \cup \mathcal{Q}_{S_{outer}}^{\prime}\right\}
\end{aligned}
$$
%
In words, $\mathcal{Q}_{S_{i}}^{(1)}$ summarizes each constraint that is forced on $S_{i}$ by $\mathcal{Q}_{S}$ and $\mathcal{Q}_{S}^{\prime}$. Let        {\small
	%
	$$
	\begin{aligned}
	%&U_{1}=\left\{u_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(1)}\right\}, \quad V_{1}=\left\{v_{1} \in\{0,1\}^{n}:\left(1, u_{1}, v_{1}\right) \in \mathcal{Q}_{S_{1}}^{(1)}\right\},\\
	&U_2^{(1)}=\left\{u_2 \in\{0,1\}^{n}:\left(2, u_2, v_2\right) \in \mathcal{Q}_{S_2}^{(1)}\right\}, \quad V_2^{(1)}=\left\{v_2 \in\{0,1\}^{n}:\left(2, u_2, v_2\right) \in \mathcal{Q}_{S_2}^{(1)}\right\},\\
	&U_3^{(1)}=\left\{u_3 \in\{0,1\}^{n}:\left(3, u_3, v_3\right) \in \mathcal{Q}_{S_3}^{(1)}\right\}, \quad V_3^{(1)}=\left\{v_3 \in\{0,1\}^{n}:\left(3, u_3, v_3\right) \in \mathcal{Q}_{S_3}^{(1)}\right\}.
	%\\
	%&U_{4}=\left\{u_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(1)}\right\}, \quad V_{4}=\left\{v_{4} \in\{0,1\}^{n}:\left(4, u_{4}, v_{4}\right) \in \mathcal{Q}_{S_{4}}^{(1)}\right\}
	\end{aligned}
	$$
}%
%
be the domains and ranges of $\mathcal{Q}_{S_2}^{(1)}$ and $\mathcal{Q}_{S_3}^{(1)}$ respectively.




\begin{definition}
	\label{defn:bad-tau-4-rounds}
	
	We say an extended transcript $\tau^{\prime}$ is bad if at least one of the following conditions is fulfilled. The conditions are classified into two categories depending on the relevant randomness. In detail, regarding $k_0,k_1,k_3,k_4$:
	\begin{itemize}[leftmargin=10mm]
		\item[\bone] there exist (not necessarily distinct) $(x,a,b,y),(x',a',b',y'),(x'',a'',b'',y'')\in \mathcal{Q}_{C}'$ and three distinct indices $i, i', i'' \in \{1, \ldots, w\}$ such that:
		\begin{itemize}
			\item $(x\xor k_0)[i]=(x'\xor k_0)[i']=(x''\xor k_0)[i'']$, or
			\item $(a\xor k_1)[i]=(a'\xor k_1)[i']=(a''\xor k_1)[i'']$, or
			\item $(b\xor T^{-1}(k_3))[i]=(b'\xor T^{-1}(k_3))[i']=(b''\xor T^{-1}(k_3))[i'']$, or
			\item $(y\xor k_4)[i]=(y'\xor k_4)[i']=(y''\xor k_4)[i'']$.
		\end{itemize}
		\item[\btwo] there exist $(x,a,b,y) \in \mathcal{Q}_{C}'$ and distinct indices $i, i' \in \{1, \ldots, w\}$ such that:
		\begin{itemize}
			\item $(x\xor k_0)[i]\in U_1^{(0)}$ and $(x\xor k_0)[i']\in U_1^{(0)}$, or
			\item $(a \oplus k_1)[i]\in U_{2}^{(0)}$ and $(a \oplus k_1)[i']\in U_{2}^{(0)}$, or
			\item $(b\xor T^{-1}(k_3))[i]\in V_3^{(0)}$ and
			$(b'\xor T^{-1}(k_3))[i']\in V_3^{(0)}$, or
			\item $(y\xor k_4)[i]\in V_4^{(0)}$ and $(y\xor k_4)[i']\in V_4^{(0)}$.
		\end{itemize}
	\end{itemize}
	%
	%
	Regarding $k_2,S_1,S_4$, and $\mathcal{Q}_S'$:
	%
	%
	\begin{itemize}[leftmargin=10mm]
		\item[\bthree] there exist $(x,a,b,y) \in \mathcal{Q}_{C}'$ and $i, j\in\{1, \ldots, w\}$ such that:
		\begin{itemize}
			\item $(a\xor k_1)[i]\in U_2^{(1)}$ and $(b\xor T^{-1}(k_3))[j]\in V_3^{(1)}$, or
			\item $(a \oplus k_1)[i]\in U_{2}^{(1)}$ and $(T(\overline{S_2}(a \oplus k_1))\xor k_2)[j]\in U_{3}^{(1)}$, or
			\item $(T^{-1}(\overline{S_3^{-1}}(b\xor T^{-1}(k_3))\xor k_2))[i]\in V_2^{(1)}$ and $(b\xor T^{-1}(k_3))[j]\in V_{3}^{(1)}$.
		\end{itemize}
		\item[\bfour] there exist $(x,a,b,y),(x',a',b',y') \in \mathcal{Q}_{C}'$ and $i, i^{\prime},j, j^{\prime} \in\{1, \ldots, w\}$, $(a,b, j) \neq \left(a^{\prime}, b',j^{\prime}\right)$, such that $(a \oplus k_1)[i]\in U_{2}^{(1)}, (a' \oplus k_1)[i']\in U_{2}^{(1)}$, and
		%
		$$\big(T(\overline{S_2}(a\xor k_1))\xor k_2\big)[j]=\big(T(\overline{S_2}(a'\xor k_1))\xor k_2\big)[j'].
		$$
		%
		\item[\bfive] there exist $(x,a,b,y),(x',a',b',y') \in \mathcal{Q}_{C}'$ and $i, i^{\prime}, j, j^{\prime} \in\{1, \ldots, w\}$, $(a,b, j) \neq \left(a',b^{\prime}, j^{\prime}\right)$, such that $\big(b \oplus T^{-1}(k_3)\big)[i]\in V_{3}^{(1)}, \big(b' \oplus T^{-1}(k_3)\big)[i']\in V_{3}^{(1)}$, and
		%
		$$\big(T^{-1}(\overline{S_3^{-1}}(b \oplus T^{-1}(k_3))\xor k_2)\big)[j]=\big(T^{-1}(\overline{S_3^{-1}}(b' \oplus T^{-1}(k_3))\xor k_2)\big)[j'].
		$$
	\end{itemize}
	Any extended transcript that is not bad will be called good. Given an original transcript $\tau$, we denote $\Theta_{\mathrm{good}}(\tau)$ (resp. $\Theta_{\mathrm{bad}}(\tau)$) the set of good (resp. bad) extended transcripts of $\tau$ and $\Theta'(\tau)$ the set of all extended transcripts of $\tau$.
\end{definition}



We start by upper bounding the probability of getting bad transcripts in the ideal world.

\begin{lemma}
	\label{lemma:bad-tau-4-rounds}
	
	Assuming $p+wq\leq N/2$, then the probability to obtain bad extended transcripts in the ideal world is bounded to
	\begin{align}
	{\Pr}\big[\tau^{\prime} \in \Theta_{\mathrm{bad}}(\tau)\big] \leq \frac{5w^2q(p+2wq)^2}{N^2}+
	\frac{3w^4q^2(p+2wq)}{N^2}.
	\label{eq:bound-bad-tau-4-rounds}
	\end{align}
\end{lemma}

The remaining of this subsection is devoted to establish Eq. (\ref{eq:bound-bad-tau-4-rounds}). To this end, we analyze the conditions in turn.



%\subsubsection{\bone, \btwo, and \bthree}
%
%\arrangespace
%
%\noindent \textsc{\bone}.
%
\subsubsection{Conditions \bone and \btwo}

For \bone, consider each of the $q^3w(w-1)(w-2)/3!\leq w^3q^3/6$ choices $(x,a,b,y),(x',a',b',y')$, $(x'',a'',b'',y'')\in \mathcal{Q}_{C}'$ and distinct $i, i', i'' \in \{1, \ldots, w\}$. Since $k_0[i]$, $k_0[i']$, and $k_0[i'']$ are uniform and independent, the probability to have $(x\xor k_0)[i]=(x'\xor k_0)[i']=(x''\xor k_0)[i'']$ is $1/N^2$. Similarly, the probability to have $(a\xor k_1)[i]=(a'\xor k_1)[i']=(a''\xor k_1)[i'']$, {\it or} $(b\xor k_3)[i]=(b'\xor k_3)[i']=(b''\xor k_3)[i'']$, {\it or} $(y\xor k_4)[i]=(y'\xor k_4)[i']=(y''\xor k_4)[i'']$, is $3/N^2$. Thus
%
$$
\operatorname{Pr}\left[\bone\right] \leq \frac{4w^3q^3}{6N^2}\leq \frac{w^3q^3}{N^2}.
$$
%



%\arrangespace

%\noindent \textsc{\btwo}.
%

Regarding \btwo, for each of the $q{w\choose 2}\leq w^2q/2$ choices of $(x,a,b, y) \in \mathcal{Q}_{C}'$ and distinct $i, i' \in \{1, \ldots, w\}$, since $k_0[i]$ and $k_0[i']$ are uniform and independent, the probability to have $(x \oplus k_{0})[i]\in U_1^{(0)}$ and $(x \oplus k_0)[i']\in U_1^{(0)}$ is at most $\big|U_1^{(0)}\big|^2/N^2=p^2/N^2$. The same bound holds for the other three conditions. Thus
%
$$
\operatorname{Pr}\left[\btwo\right] \leq \frac{w^{2} q}{2}\cdot\frac{4p^2}{N^2}\leq\frac{2w^{2} q p^2}{N^{2}}.
$$
%



%Regarding \bthree, for each of the $w^2q$ choices of $(x,a,b,y)\in\mathcal{Q}_{C}'$ and indices $i, j \in \{1, \ldots, w\}$, since $k_{0}$ and $k_1$ are uniform and independent, the probability to have $\left(x \oplus k_{0}\right)[i]\in U_1^{(0)}$ and $\left(a\oplus k_{1}\right)[j]\in U_2^{(0)}$ is $p^2/N^2$. The same bound holds for the other condition. Thus
%%
%$$
%\operatorname{Pr}\left[\bthree\right] \leq \frac{w^{2} q}{2}\cdot\frac{2p^2}{N^2}\leq\frac{w^{2} q p^2}{N^{2}}.
%$$
%




\subsubsection{Useful intermediate results}



To analyze the remaining conditions, we will rely on the following lemma, which characterizes some useful properties of the $t$-th round of the linear SPN.

\begin{lemma}
	\label{lemma:coll-prob}
	
	For any $t\in\{1,2\}$, $r\in\{3,4\}$, $z,z',\delta\in\{0,1\}^n$, and $i,i',j,j'\in\{1,\ldots,w\}$, define      {\small
	\begin{align*}
	&\pcoll_{1}^+(t,z,z',j,j')  :={\Pr}\Big[\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[j]=\big(T\big(\overline{S_t}(z'\xor k_{t-1})\big)\xor k_t\big)[j']       \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_t\vdash\mathcal{Q}_{S_t}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_{t-1})[\ell]\notin U_t^{(0)}\Big],         \\
	&\pcoll_{2}^+(t,z,z',i,i',j,j')      :={\Pr}\Big[\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[j]=\big(T\big(\overline{S_t}(z'\xor k_{t-1})\big)\xor k_t\big)[j']   \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_t\vdash\mathcal{Q}_{S_t}^{(0)}\wedge(z\xor k_{t-1})[i]\in U_t^{(0)}\wedge(z'\xor k_{t-1})[i']\in U_t^{(0)}\Big],         \\
	%
	&\pcoll_{3}^+(t,z,i,\delta)      :={\Pr}\Big[\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[i]=\delta    \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_t\vdash\mathcal{Q}_{S_t}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_{t-1})[\ell]\notin U_t^{(0)}\Big],         \\
	%
	&\pcoll_{1}^-(r,z,z',j,j')     :={\Pr}\Big[\big(T^{-1}\big(\overline{S_r^{-1}}(z\xor k_r)\big)\xor k_{r-1}\big)[j]=\big(T^{-1}\big(\overline{S_r^{-1}}(z'\xor k_r)\big)\xor k_{r-1}\big)[j']    \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_r\vdash\mathcal{Q}_{S_r}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_r)[\ell]\notin V_r^{(0)}\Big],         \\
	&\pcoll_{2}^-(r,z,z',i,i',j,j')    :={\Pr}\Big[\big(T^{-1}\big(\overline{S_r^{-1}}(z\xor k_r)\big)\xor k_{r-1}\big)[j]=\big(T^{-1}\big(\overline{S_r^{-1}}(z'\xor k_r)\big)\xor k_{r-1}\big)[j']     \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_r\vdash\mathcal{Q}_{S_r}^{(0)}\wedge(z\xor k_r)[i]\in V_r^{(0)}\wedge(z'\xor k_r)[i']\in V_r^{(0)}\Big],         \\
	%
	&\pcoll_{3}^-(r,z,i,\delta)      :={\Pr}\Big[\big(T^{-1}\big(\overline{S_r^{-1}}(z\xor k_r)\big)\xor k_{r-1}\big)[i]=\delta    \\
	&\midindent~\Big|~\neg\bone\wedge\neg\btwo\wedge S_r\vdash\mathcal{Q}_{S_r}^{(0)}\wedge\forall\ell\in\{1,\ldots,w\}:(z\xor k_r)[\ell]\notin V_r^{(0)}\Big],
	\end{align*}
}%	
	where the probabilities are taken over the random choices of $S_t$, $k_{t-1}$, $k_t$, $S_r$, $k_{r-1}$, and $k_r$. Then, as long as $(z,j)\neq(z',j')$, it holds
	\begin{align}
	&\pcoll_{1}^+(t,z,z',j,j')\leq\frac{1}{N-p-wq},  &\pcoll_{2}^+(t,z,z',i,i',j,j')\leq\frac{1}{N-p-wq},    \notag    \\
	&\pcoll_{1}^-(r,z,z',j,j')\leq\frac{1}{N-p-wq},  &\pcoll_{2}^-(r,z,z',i,i',j,j')\leq\frac{1}{N-p-wq}.    \notag   \\
	&\pcoll_{3}^+(t,z,i,\delta)\leq\frac{1}{N}, 
	&\pcoll_{3}^-(r,z,i,\delta)\leq\frac{1}{N}.    \notag
	\end{align}
\end{lemma}
\begin{proof}
	%Consider the probability to have $T\big(\overline{S_t}(z\xor k)\big)[j]$ equal a constant $\delta$ first. By $\neg\bone$, the exists at most 1 index $i_1$ such that $(x\xor k_0)[i_1]=(x\xor k_0)[1]$. By these, we write
	%%
	%\begin{align*}
	%& (T(\overline{S_1}(x\xor k_0)))[i]       \\
	%= &
	%\Big(t_{i,1}\cdot S_1\big((x\xor k_0)[1]\big)
	%\xor
	%t_{i,i_0}\cdot S_1\big((x\xor k_0)[i_0]\big)\Big)
	%\xor
	%\bigoplus_{2\leq\ell\leq w,\ell\neq i_1}t_{i,\ell}\cdot S_1\big((x\xor k_0)[\ell]\big)     \\
	%= &
	%\Big(\big(t_{i,1}\xor t_{i,i_0}\big)\cdot S_1\big((x\xor k_0)[1]\big)\Big)
	%\xor
	%\bigoplus_{2\leq\ell\leq w,\ell\neq i_1}t_{i,\ell}\cdot S_1\big((x\xor k_0)[\ell]\big)    .
	%\end{align*}
	%%
	%
	%
	%Conditioned on $S_1\vdash\mathcal{Q}_{S_1}^{(0)}$ and on the $w-2$ values $\big\{S_1((x\xor k_0)[i'])\}_{2\leq i'\leq w,i'\neq i_1}$, \textbf{the value of $S_1((x \oplus k_0)[0])$ remains uniform in at least $N-p-wq$ values. Moreover, the coefficient $t_{i,1}\xor t_{i,i_0}$ is non-zero as per our assumption. Therefore,} the probability to have $(a\xor k_1)[i]=(T(\overline{S_1}(x\xor k_0)))[i]\xor k_1[i]$ equal some constant $\delta$ is at most $1/(N-p-wq)$.
	%
	%
	%Similarly, the probability of $(b\xor T^{-1}(k_3))[j]\in U_2^{(1)}$ is at most $1/(N-p-wq)$.
	First, consider $\pcoll_{1}^+(t,z,z',j,j')$. When $j\neq j'$, the probability to have
	$\big(T\big(\overline{S_t}(z\xor k_{t-1})\big)\xor k_t\big)[j]=\big(T\big(\overline{S_t}(z'\xor k_{t-1})\big)\xor k_t\big)[j']$ is $1/N\leq 1/(N-p-wq)$, since $k_t[j]$ and $k_t[j']$ are uniform and independent. In the remaining we focus on the case of $j=j'$, which means $z\neq z'$ while $T\big(\overline{S_t}(z\xor k_{t-1})\big)[j]=T\big(\overline{S_t}(z'\xor k_{t-1})\big)[j]$. Note that $z\neq z'$ implies there exists $i_0$ such that $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[i_0]$. By the assumption, $(z\xor k_{t-1})[i_0]\notin U_1^{(0)}$. By construction, we have
	%
	\begin{align*}
	&  T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]       \\
	= &
	\Big(\bigoplus_{1\leq\ell\leq w}t_{j,\ell}\cdot S_t\big((z\xor k_{t-1})[\ell]\big)\Big)\xor
	\Big(\bigoplus_{1\leq\ell\leq w}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)   .
	\end{align*}
	%
	Below we distinguish 3 cases:
	
	
	%
	%\reducespace
	%
	%\subsubsection{Case 1: $(z\xor k_{t-1})[i_0]$ is ``unique'',}
	
	
	
	\paragraph{Case 1: $(z\xor k_{t-1})[i_0]$ is ``unique'',}
	
	i.e., $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[\ell]$ for all $\ell\in\{1,\ldots,w\}$, and $(z\xor k_{t-1})[i_0]\neq(z\xor k_{t-1})[\ell]$ for all $\ell\neq i_0$. Then, conditioned on $S_t\vdash\mathcal{Q}_{S_t}^{(0)}$ and on the $2w-1$ values $\{S_t((z\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_0}\cup\{S_t((z'\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w}$, the value of $S_t\big((z\xor k_{t-1})[i_0]\big)$ remains uniform in {\it at least} $N-p-wq$ possibilities. Moreover, the coefficient $t_{j,i_0}$ is non-zero as per our assumption. Therefore, in this case we have
	%
	\begin{align}
	{\Pr}\big[T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]=0\big]\leq\frac{1}{N-p-wq}.
	\label{eq:bound-eq-B33}
	\end{align}
	%
	
	%
	%\reducespace
	%
	%\reducespace
	%
	%\reducespace
	%
	%\subsubsection{Case 2: $(z\xor k_{t-1})[i_0]=(z\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	\paragraph{Case 2: $(z\xor k_{t-1})[i_0]=(z\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	Then by $\neg\bone$, $(z\xor k_{t-1})[i_0]\neq(z\xor k_{t-1})[\ell]$ and $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[\ell]$ for any $\ell\neq i_0,i_1$. We further distinguish two subcases:
	\begin{itemize}
		\item Subcase 2.1: $(z\xor k_{t-1})[i_1]=(z'\xor k_{t-1})[i_1]$. Then, with the two terms $t_{j,i_1}\cdot S_t\big((z\xor k_{t-1})[i_1]\big)$ and $t_{j,i_1}\cdot S_t\big((z'\xor k_{t-1})[i_1]\big)$ canceled, it can be seen
		%
		\begin{align*}
		&  T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]       \\
		= &
		\Big(\bigoplus_{1\leq\ell\leq w,\ell\neq i_1}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)\xor
		\Big(\bigoplus_{1\leq\ell\leq w,\ell\neq i_1}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)   .
		\end{align*}
		%
		Conditioned on $S_t\vdash\mathcal{Q}_{S_t}^{(0)}$ and on the $2w-3$ values $\{S_t((z'\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_1}\cup\{S_t((z\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_0,\ell\neq i_1}$, the value of $S_t((z\xor k_{t-1})[i_0])$ remains uniform in {\it at least} $N-p-wq$ possibilities. Therefore, in this case Eq. (\ref{eq:bound-eq-B33}) still holds.
		\item Subcase 2.2: $(z\xor k_{t-1})[i_1]\neq(z'\xor k_{t-1})[i_1]$. Then we write
		%
		\begin{align*}
		&  T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z'\xor k_{t-1}))[j]       \\
		= &   \underbrace{\Big(t_{j,i_0}\cdot S_t\big((z\xor k_{t-1})[i_0]\big)
			\xor
			t_{j,i_1}\cdot S_t\big((z\xor k_{t-1})[i_1]\big)\Big)}_{\big(t_{j,i_0}\xor t_{j,i_1}\big)\cdot S_t\big((z\xor k_{t-1})[i_0]\big)}   	\\
		&\hugeindent\xor
		\Big(\bigoplus_{1\leq\ell\leq w}t_{j,\ell}\cdot S_t\big((z'\xor k_{t-1})[\ell]\big)\Big)    \xor
		\Big(\bigoplus_{\ell\neq i_0,\ell\neq i_1}t_{j,\ell}\cdot S_t\big((z\xor k_{t-1})[\ell]\Big).
		\end{align*}
		%
		Conditioned on $S_t\vdash\mathcal{Q}_{S_t}^{(0)}$ and on the $2w-2$ values $\{S_t((z'\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w}\cup\{S_t((x\xor k_{t-1})[\ell])\}_{1\leq \ell\leq w,\ell\neq i_0,\ell\neq i_1}$, $S_t((z\xor k_{t-1})[i_0])$ remains uniform in at least $N-p-wq$ possibilities. Moreover, the coefficient $t_{j,i_0}\xor t_{j,i_1}$ is non-zero as per our assumption. Therefore, Eq. (\ref{eq:bound-eq-B33}) remains.
	\end{itemize}
	
	
	
	%\reducespace
	%
	%\reducespace
	%
	%\subsubsection{Case 3: $(z\xor k_{t-1})[i_0]=(z'\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	\paragraph{Case 3: $(z\xor k_{t-1})[i_0]=(z'\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$.}
	
	The subcase and discussion are similar to Case 2.
	
	
	
	\arrangespace
	
	
	By the above, in any case, the probability to have $T(\overline{S_t}(z\xor k_{t-1}))[j]=T(\overline{S_t}(z'\xor k_{t-1}))[j]$ is at most $1/(N-p-wq)$, which establishes $\pcoll_{1}^+(t,z,z',j,j')\leq1/(N-p-wq)$. Similarly by symmetry, $\pcoll_{1}^-(r,z,z',j,j')\leq1/(N-p-wq)$.
	
	
	
	
	\arrangespace
	
	
	The analysis of $\pcoll_{2}^+(t,z,z',i,i',j,j')$ bears some resemblance. In particular, we focus on the case of $j=j'$ (and thus $z\neq z'$), as otherwise the uniformness of $k_t[j]$ and $k_t[j']$ is sufficient for $\pcoll_{2}^+(t,z,z',i,i',j,j')=1/N$.
	
	
	First, consider $\pcoll_{2}^+(t,z,z',i,i',j,j)$ with $i\neq i'$. Since $z\neq z'$, there exists $i_0$ such that $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[i_0]$. Then either $i\neq i_0$ or $i'\neq i_0$. Wlog assume $i\neq i_0$. Note that this means $(z\xor k_{t-1})[i]\neq(z'\xor k_{t-1})[i_0]$, as otherwise both $(z\xor k_{t-1})[i]$ and $(z\xor k_{t-1})[i_0]$ fall in $U_1^{(0)}$ and it contradicts $\neg\btwo$. In the same vein as the analysis of $\pcoll_{1}^+(t,z,z',j,j')$, we then distinguish three cases. In detail,
	%
	\begin{itemize}
		\item Case 1: $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[\ell]$ for all $\ell\in\{1,\ldots,w\}$, and $(z\xor k_{t-1})[i_0]\neq(z\xor k_{t-1})[\ell]$ for any $\ell\neq i_0$. Then the analysis is similar to Case 1 in the analysis of $\pcoll_{1}^+(t,z,z',j,j')$.
		\item Case 2: $(z\xor k_{t-1})[i_0]=(z\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$. Then, if $(z\xor k_{t-1})[i_1]=(z'\xor k_{t-1})[i_1]$, then the two terms $t_{j,i_1}\cdot S_t\big((z\xor k_{t-1})[i_1]\big)$ and $t_{j,i_1}\cdot S_t\big((z'\xor k_{t-1})[i_1]\big)$ cancel, and the remaining term $t_{j,i_0}\cdot S_t\big((z\xor k_{t-1})[i_0]\big)$ ensures that the probability is at most $1/(N-p-wq)$; otherwise, the term $(t_{j,i_0}\xor t_{j,i_1})\cdot S_t((z\xor k_{t-1})[i_0])$ ensures that the probability is at most $1/(N-p-wq)$.
		\item Case 3: $(z\xor k_{t-1})[i_0]=(z'\xor k_{t-1})[i_1]$ for some $i_1\neq i_0$. This subcase is similar to Case 2.
	\end{itemize}
	%
	%The remaining discussion resembles the previous one for $\pcoll_{1}^+(t,z,z',j)$, which consists of 3 cases shown in Appendix XXX.
	In all, the uniformness of $S_t((z\xor k_{t-1})[i_0])$ is sufficient to ensure ${\Pr}\big[T(\overline{S_t}(z\xor k_{t-1}))[j]=T(\overline{S_t}(z\xor k_{t-1}))[j]\big]\leq1/(N-p-wq)$.
	
	
	
	\arrangespace
	
	
	Then, consider the case of $i=i'$, i.e., $\pcoll_{2}^+(t,z,z',i,i,j,j)$. Assume that $S_t((z\xor k_{t-1})[i])=u_t$ and $S_t((z'\xor k_{t-1})[i])=u_t'$ for $(u_t,v_t),(u_t',v_t')\in\mathcal{Q}_{S_t}^{(0)}$. Then it holds      {\small
		%
		\begin{align}
		&   T(\overline{S_t}(z\xor k_{t-1}))[j]\xor T(\overline{S_t}(z\xor k_{t-1}))[j]        \notag   \\
		= &
		(t_{j,i}\cdot v_1)
		\xor
		(t_{j,i}\cdot v_1')
		\xor
		\Big(\bigoplus_{1\leq\ell\leq w,\ell\neq i}t_{j,\ell}\cdot
		\big(S_1((x\xor k_0)[\ell])\xor S_1((x'\xor k_0)[\ell])\big)\Big)    .
		\label{eq:interm-eq-b2}
		\end{align}
	}%
	%
	%
	%
	%Assume that $\overline{S_1}(x\xor k_0)=\bfv_1\|v_1\|\bfv_2$ and
	%$\overline{S_1}(x'\xor k_0)=\bfv_1'\|v_1'\|\bfv_2'$, where $v_1,v_1'\in V_1^{(0)}$. Then the equality $T(\overline{S_1}(x\xor k_0))[j]=T(\overline{S_1}(x'\xor k_0))[j]$ implies
	%
	%\begin{align}
	%\bft_1^*\cdot\bfv_1\xor t^*\cdot v_1\xor\bft_2^*\cdot\bfv_2=\bft_1^*\cdot\bfv_1'\xor t^*\cdot v_1'\xor\bft_2^*\cdot\bfv_2'.
	%\label{eq:interm-eq-b2}
	%\end{align}
	%
	%
	%for two vectors $\bft_1^*,\bft_2^*$ and $t^*\in\{0,1\}^n$.
	Now:
	\begin{itemize}
		\item If $x[\ell]=x'[\ell]$ for any $\ell\neq i$, then $z\neq z'$ implies $v_1\neq v_1'$. In this case, Eq. (\ref{eq:interm-eq-b2}) collapses to $t_{j,i}\cdot v_1=t_{j,i}\cdot v_1'$ which is not possible since $t_{j,i}\neq 0$;
		\item Else, there exists $i_0\neq i$ such that $(z\xor k_{t-1})[i_0]\neq(z'\xor k_{t-1})[i_0]$. This means $(z'\xor k_{t-1})[i]\notin U_t^{(0)}$ (and thus $(z'\xor k_{t-1})[i]\neq(z\xor k_{t-1})[i_0]$) by $\neg\btwo$. The remaining analysis just follows the previous one for $\pcoll_{1}^+(t,z,z',j)$, establishing that the uniformness of $S_t((z\xor k_{t-1})[i_0])$ is sufficient to ensure that $T(\overline{S_t}(z\xor k_{t-1}))[j]$ equals $T(\overline{S_t}(z\xor k_{t-1}))[j]$ with probability at most $1/(N-p-wq)$.
	\end{itemize}
	Therefore, it still holds $\pcoll_{2}^+(t,z,z',i,i,j,j)\leq1/(N-p-wq)$. All the above cases show that $\pcoll_{2}^+(t,z,z',i,i',j,j')\leq1/(N-p-wq)$ for any parameters. Similarly by symmetry, $\pcoll_{2}^-(r,z,z',i,i',j,j')\leq1/(N-p-wq)$.
	
	
	\arrangespace
	
	
	
	Finally, since $k_t[i]$ is uniform and independent of $k_{t-1}$ and $S_t$, it immediately holds
	$$\pcoll_{3}^+(t,z,i,\delta)=\frac{1}{N}.$$
	Similarly, $\pcoll_{3}^-(r,z,i,\delta)=\frac{1}{N}$. These complete the proof.
\end{proof}





%\arrangespace

%\noindent \textsc{\bfour and \bfive}.
%

\subsubsection{Conditions \bthree, \bfour, and \bfive}


Regarding \bthree, consider any choice of $(x,a,b,y)$ and $i, j$. Consider the probability to have $(a\xor k_1)[i]\in U_2^{(1)}$ first. Note that this consists of three subevents:
\begin{itemize}
	\item(B-31) $(a\xor k_1)[i]\in U_2^{(0)}$;
	\item(B-32) there exists $(x',a',b',y')\in\mathcal{Q}_{C}'$, and $j'\in\{1,\ldots,w\}$ such that $(x,j)\neq(x',j')$, while $(a\xor k_1)[j]=(a'\xor k_1)[j']$.
\end{itemize}
Since $k_1$ is uniform and independent of $S_1$, it holds $\Pr[\text{(B-31)}]\leq p/N$.


For (B-32), consider each $((x',a',b',y'),j')$ such that $(x,j)\neq(x',j')$, we distinguish three cases.
\begin{itemize}
	\item Case 1: $(x\xor k_0)[\ell]\notin U_1^{(0)}$ for all $\ell\in\{1,\ldots,w\}$. Then we have $\pcoll_{1}^+(1,x,x',j,j')\leq1/(N-p-wq)$ by Lemma \ref{lemma:coll-prob}.
	%
	\item Case 2: there exists $i_1$ such that $(x\xor k_0)[i_1]\in U_1^{(0)}$, though $(x'\xor k_0)[\ell]\notin U_1^{(0)}$ for all $\ell\in\{1,\ldots,w\}$. Then we have $\pcoll_{1}^+(1,x',x,j',j)\leq1/(N-p-wq)$ by Lemma \ref{lemma:coll-prob}.
	%
	\item Case 3: there exists $i_1,i_2$ such that $(x\xor k_0)[i_1]\in U_1^{(0)}$ and $(x'\xor k_0)[i_2]\in U_1^{(0)}$. Then we have  $\pcoll_{2}^+(1,x,x',i_1,i_2,j,j')\leq1/(N-p-wq)$ by Lemma \ref{lemma:coll-prob}.
\end{itemize}
%
Therefore, for any $((x',a',b',y'),j')$, the probability to have $(a\xor k_1)[j]=(a'\xor k_1)[j']$ never exceeds $1/(N-p-wq)$. By this, $\Pr[\text{(B-32)}]\leq wq/(N-p-wq)$. Using $p+wq\leq N/2$, we reach
%
$${\Pr}\big[(a\xor k_1)[i]\in U_2^{(1)}\big]
\leq\Pr[\text{(B-31)}]+\Pr[\text{(B-32)}]\leq
\frac{p}{N}+\frac{wq}{(N-p-wq)}\leq\frac{p+2wq}{N}.$$
%

Via deriving one round further in a similar vein, we reach,
%
$${\Pr}\big[(T(\overline{S_2}(a \oplus k_1))\xor k_2)[j]\in U_{3}^{(1)}\big]\leq\frac{p+2wq}{N},$$
%
and similarly by symmetry,
%
\begin{align*}
&{\Pr}\big[(b\xor T^{-1}(k_3))[j]\in V_3^{(1)}\big]\leq\frac{p+2wq}{N},       \\
&{\Pr}\big[(T^{-1}(\overline{S_3^{-1}}(b\xor T^{-1}(k_3))\xor k_2))[i]\in V_2^{(1)}\big]\leq\frac{p+2wq}{N}.
\end{align*}
%
By this, the probability that \bthree is fulfilled with respect to each choice of $((x,a,b,y),i, j)$ is at most $3(p+2wq)^2/N^2$. As there are at most $w^2q$ choices for $(x,a,b,y)$ and $i, j$, we eventually obtain
%
$$
{\Pr}\big[\bthree\big] \leq \frac{3w^2q(p+2wq)^2}{N^2}.
$$



%\input{discared-argument.tex}




\arrangespace

\noindent\textsc{\bfour and \bfive}. For \bfour, we have
%
\begin{align*}
\Pr[\bfour] 
=   &  \sum_{(x,a,b,y),(x',a',b',y')\in\mathcal{Q}_{C}'}\sum_{i,i',j,j'}\bigg(\underbrace{{\Pr}\big[(a\xor k_1)[i]\in U_2^{(1)}\big]}_{\leq(p+2wq)/N\text{, as argued before}}     \\
& \midindent\times
\underbrace{{\Pr}\big[(a'\xor k_1)[i]\in U_2^{(1)}|(a\xor k_1)[i]\in U_2^{(1)}\big]}_{\leq1}\times\underbrace{\pcoll_{2}^+(2,a,a',i,i',j,j')}_{\leq1/(N-p-wq)}   \bigg)      \\
\leq  &  {wq\choose 2}\cdot w^2\cdot\frac{p+2wq}{N}\cdot\frac{1}{N-p-wq}\leq
\frac{w^4q^2(p+2wq)}{N^2}.
\end{align*}
%

Similarly by symmetry,
%
\begin{align*}
\Pr[\bfive] 
\leq
\frac{w^4q^2(p+2wq)}{N^2}.
\end{align*}




\subsubsection{Summary for bad transcripts}


Summing over the above and using $\frac{w^3q^3}{N^2}\leq\frac{w^4q^2(p+2wq)}{N^2}$ and $\frac{2w^{2} q p^2}{N^{2}}\leq\frac{2w^2q(p+2wq)^2}{N^2}$ yield Eq. (\ref{eq:bound-bad-tau-4-rounds}):
%
\begin{align*}
&  {\Pr}\big[ \tau' \in \Theta_{\text {bad }}(\tau)\big]  \leq \sum_{i=1}^{5}\Pr[\bi]       \\
\leq~  & \frac{w^3q^3}{N^2}+
\frac{2w^{2} q p^2}{N^{2}}+
\frac{3w^2q(p+2wq)^2}{N^2}+
\frac{w^4q^2(p+2wq)}{N^2}+
\frac{w^4q^2(p+2wq)}{N^2}             \\
\leq~  & \frac{5w^2q(p+2wq)^2}{N^2}+
\frac{3w^4q^2(p+2wq)}{N^2}.
\end{align*}
%




%\paragraph{\textsc{The inner two rounds.}}


\subsection{Analyzing Good Transcript Extensions}
\label{sec:good-tau-4-rounds}

We are now ready for the second step of the reasoning. Define
%
$$\calC_{\bfk}^T[\calS](a):=   \overline{S_3}(T(\overline{S_2}(a\xor k_1))\xor k_2)\xor T^{-1}(k_3).$$
%
For any attainable transcript $\tau$, the ideal world probability is easy to calculate:
%
%
\begin{align*}
\mathsf{p}_{1}(\tau)=&\operatorname{Pr}\left[(P,\mathcal{S})\stackrel{\$}{\leftarrow} {\mathsf{Perm}}(wn)\times\mathsf{Perm}(n)^4: (\mathcal{S} \vdash \mathcal{Q}_{S}) \wedge(P \vdash \mathcal{Q}_{C})  \right]		\\
=&\frac{1}{(N^w)_q}\cdot\bigg(\frac{1}{(N)_p}\bigg)^4.
\end{align*}



To reach the real world probability $\mathsf{p}_2(\tau)$, consider any transcript extension $\tau'=(\mathcal{Q}_{C}',\mathcal{Q}_{S},\mathcal{Q}_{S}',S_1^*,S_4^*,\bfk)$ from $\tau$. Denote
%
%
\begin{align}
\mathsf{p}_{\mathrm{re}}(\tau') = & \operatorname{Pr}\Big[\left(\mathbf{k}',\mathcal{S}\right) \stackrel{\$}{\leftarrow} \big(\{0,1\}^{wn}\big)^5 \times \mathsf{Perm}(n)^4:
\Big(\big(S_1=S_1^*\big)\wedge\big(S_4=S_4^*\big)\wedge		\notag 	\\
&\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\big(S_2\vdash\mathcal{Q}_{S_2}^{(1)}\big)\wedge\big(S_3\vdash\mathcal{Q}_{S_3}^{(1)}\big)\wedge\big(\calC_{\bfk'}^T[\calS] \vdash \mathcal{Q}_C'\big)\wedge\big(\bfk'=\bfk\big)\Big)\Big]	 	\notag 	\\
\mathsf{p}_{\mathrm{mid}}(\tau') = & \operatorname{Pr}\Big[\mathcal{S} \stackrel{\$}{\leftarrow}\mathsf{Perm}(n)^4:(\calC_{\bfk}^T[\calS] \vdash \mathcal{Q}_C')~\Big|~
(S_1=S_1^*)\wedge (S_4=S_4^*)\wedge	 	\notag 	\\
&\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent\codeindent (S_2\vdash\mathcal{Q}_{S_2}^{(1)})\wedge (S_3\vdash\mathcal{Q}_{S_3}^{(1)})\Big].	 	\notag 	
%\label{eq:defn-p-mid}
\end{align}
%
%
%
and let $\alpha_1=|\mathcal{Q}_{S_2}^{(1)}|-|\mathcal{Q}_{S_2}^{(0)}|=|\mathcal{Q}_{S_2}^{(1)}|-p$ and $\alpha_2=|\mathcal{Q}_{S_3}^{(1)}|-p$. With these, we have
%
%
\begin{align*}
\mathsf{p}_2(\tau)=&\operatorname{Pr}\left[\left(\mathbf{k},\mathcal{S}\right) \stackrel{\$}{\leftarrow} \big(\{0,1\}^{wn}\big)^5 \times \mathsf{Perm}(n)^4:\big(\spn_{\bfk}^{T}[\mathcal{S}] \vdash \mathcal{Q}_{C}\big) \wedge \big(\mathcal{S} \vdash \mathcal{Q}_{S}\big)\right]		\\
\geq & \sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)} \mathsf{p}_{\mathrm{re}}(\tau')  
\geq
\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
%
\frac{1}{N^{5w}\big((N)_{N}\big)^2(N)_{p+\alpha_1}(N)_{p+\alpha_2}}\cdot \mathsf{p}_{\mathrm{mid}}(\tau')  .
\end{align*}
%
%
Therefore,
%
%
\begin{align*}
\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}   \geq  &
\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
\frac{(N^w)_q\cdot\big((N)_p\big)^4}{N^{5w}\big((N)_{N}\big)^2(N)_{p+\alpha_1}(N)_{p+\alpha_2}}\cdot \mathsf{p}_{\mathrm{mid}}(\tau')         \\
\geq  &    \min_{\tau' \in \Theta_{\mathrm{good}}(\tau)}\big((N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau')\big)
\underbrace{\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
	\frac{1}{N^{5w}\big((N-p)_{N-p}\big)^2(N-p)_{\alpha_1}(N-p)_{\alpha_2}}}_{B} .
\end{align*}



Note that, the exact probability of observing the extended transcript $\tau'$ is
%
%
$$\frac{1}{N^{5w}\big((N-p)_{N-p}\big)^2(N-p)_{\alpha_1}(N-p)_{\alpha_2}},$$
%
since:
%
\begin{itemize}
	\item[1.] sample keys $k_0,\ldots,k_4\in\{0,1\}^{wn}$ uniformly and independently at random;
	\item[2.] sample two random permutations $S_1,S_4$ from $\mathsf{Perm}(n)$ at uniform, such that $S_1\vdash\mathcal{Q}_{S_1}^{(0)},S_4\vdash\mathcal{Q}_{S_4}^{(0)}$.
	\item[3.] choose the partial extension of the S-box queries based on the new collisions $\mathcal{Q}_{S}^{\prime}$ uniformly at random (meaning that each possible $\mathnormal{u}$ or $\mathnormal{v}$ is chosen uniformly at random in the set of its authorized values).
\end{itemize}
%
%
This means the term $B$ captures the probability of good transcript extensions:
%
%
\begin{align}
B=&\sum_{\tau^{\prime} \in \Theta_{\mathrm{good}}(\tau)}
\frac{1}{N^{5w}\big((N-p)_{N-p}\big)^2(N-p)_{\alpha_1}(N-p)_{\alpha_2}}  \notag   \\
=&{\Pr}\big[ \tau' \in \Theta_{\text {good }}(\tau)\big] \geq  1- {\Pr}\big[ \tau' \in \Theta_{\text {bad }}(\tau)\big],   \notag
\end{align}
%
%
which further implies
%
%
\begin{align}
\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}   \geq  {\Pr}\big[ \tau' \in \Theta_{\text {good }}(\tau)\big]\cdot
\min_{\tau' \in \Theta_{\mathrm{good}}(\tau)}\big((N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau')\big). 
\label{eq:ratio-divide-4-rounds}
\end{align}
%
%


The term $\mathsf{p}_{\mathrm{mid}}(\tau')$ captures the probability that $\calC_{\bfk'}^T[\calS] \vdash \mathcal{Q}_C'$, i.e., the inner two SPN rounds are consistent with the pairs of inputs/outputs $(a,b)$ defined in $\mathcal{Q}_C'$. We appeal to~\cite{EPRINT:CogLee18} to have a concrete bound on $(N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau')$.

\begin{lemma}
	\label{lemma:bound-middle-two-rounds}
	
	Assume $p+wq\leq N/2$, then
	\begin{align}
	(N^w)_q\cdot\mathsf{p}_{\mathrm{mid}}(\tau') \geq 1-\frac{q^2}{N^w}-\frac{q(2wp+6w^2q)^2}{N^2}.
	\label{eq:bound-on-epsilon-mid}
	\end{align}
\end{lemma}
\begin{proof}
	It can be checked that, the transcript $(\mathcal{Q}_C',\mathcal{Q}_{S_2}^{(1)},\mathcal{Q}_{S_3}^{(1)})$ satisfies exactly the conditions defining a good transcript as per~\cite[page 16]{EPRINT:CogLee18}. Moreover,
	the ratio $\mathsf{p}_{\mathrm{mid}}(\tau')/(1/(N^w)_q)$ is exactly the ratio of the probabilities to get $\tau'$ in the real and in the ideal world. The result thus immediately follows from~\cite[Lemma 9]{EPRINT:CogLee18}.
\end{proof}



%The previous proof is conditioned on $S_{1} \vdash \mathcal{Q}_{S_{1}}, S_{4} \vdash \mathcal{Q}_{S_{4}}$, but $\operatorname{Pr}\left[ \tau_{inner}^{\prime} \in \Theta_{\text {good }}(\tau_{inner})\right]$, we need to consider $S_{1} \vdash \mathcal{Q}_{S_{1}}^{(1)}, S_{4} \vdash \mathcal{Q}_{S_{4}}^{(1)}$. That is the probability $\left(T\left(S_{1}\left(x \oplus k_{0}\right) \oplus k_{1}\right)\right)[i]=u_2$ or $\left(T^{-1}\left(S_{4}^{-1}\left(y \oplus k_{4}\right)\right) \oplus k_{3}\right)[j]=v_3$ hold is at most $\frac{1}{(N-p-w q)}$, so
%
%\begin{equation}
%\begin{aligned}
%\operatorname{Pr}\left[ \tau_{inner}^{\prime} \in \Theta_{\text {good }}(\tau_{inner})\right] \geq 1&- \frac{2 w^{2} q (p+w q)^{2}}{(N-p-w q)} -\frac{2 w^{2} q (p+w q)(p+w q+2 q)}{N \cdot (N-p-w q)}\\
%&- \frac{w^{2} q (p+w q)(p+w q+2 q)}{(N-p-w q)^2} - \frac{2 w^{2} q^{2} (p+w q)}{(N- p- wq)^2}.
%\end{aligned}
%\end{equation}



Gathering Eqs. (\ref{eq:bound-bad-tau-4-rounds}), (\ref{eq:ratio-divide-4-rounds}), and (\ref{eq:bound-on-epsilon-mid}), and using $\frac{q(2wp+6w^2q)^2}{N^2}\leq\frac{4w^2q(p+3wq)^2}{N^2}$, we obtain
%
\begin{align*}
\frac{\mathsf{p}_{2}(\tau)}{\mathsf{p}_{1}(\tau)}   \geq   & \bigg(1-
%
\frac{5w^2q(p+2wq)^2}{N^2}-
\frac{3w^4q^2(p+2wq)}{N^2}
%
\bigg)\cdot\bigg(1-\frac{q^2}{N^w}-\frac{q(2wp+6w^2q)^2}{N^2}\bigg)     \notag      \\
\geq  &  1-\frac{5w^2q(p+2wq)^2}{N^2}-
\frac{3w^4q^2(p+2wq)}{N^2}-\frac{q^2}{N^w}-\frac{4w^2q(p+3wq)^2}{N^2}     \notag        \\
\geq  &  1-
\frac{3w^4q^2(p+2wq)}{N^2}-\frac{q^2}{N^w}-\frac{9w^2q(p+3wq)^2}{N^2}     \notag   
\end{align*}
%
as claimed in Eq. (\ref{eq:bound-proximity-4-round}).





\section{Conclusion}

We show that, with four rounds and a moderately stronger linear permutation layer, a linear substitution-permutation network is secure up to $2^{2n/3}$ adversarial queries, which overcomes the birthday barrier. This provides additional theoretic supports for the real world SPN (tweakable) blockciphers.

We conjecture that the $2^{2n/3}$ security is tight for 4 or 3 rounds. Though, we are not aware of matching attacks. Moreover, whether 3 rounds are sufficient has been open since~\cite{EPRINT:DKSTZ17}. We also remark that: (a) the security of $t$-round linear SPNs for general $t$ remains open, and (b) whether tweaks can be mixed into the construction via xoring, like~\cite{AC:CogSeu15}, to ensure beyond-birthday-bound security, remains unknown.



\section*{Acknowledgements}

Yuan Gao and Chun Guo were partly supported by the Program of Qilu Young Scholars (Grant No. 61580089963177) of Shandong University. Meiqin Wang was supported by National Key Research and Development Project under Grant No.2018YFA0704702, and Major Scientific and Technological Innovation Project of Shandong Province, China under Grant No. 2019JZZY010133. Weijia Wang was partly supported by the Program of Qilu Young Scholars (Grant No. 61580082063088) of Shandong University.



%\bibliography{reference-set,crypto/abbrev3,crypto/crypto}
\input{main.bbl}


\appendix


\section{Candidate Good Transformations for Definition \ref{defn:good-T}}
\label{sec:candidates-good-linear}

For $n=8$, the search space is sufficiently small for a naive exhaustive search. Concretely, using the primitive polynomial $x^8+x^4+x^3+x+1$, two candidates for $n = 8$ and $w = 8$ respectively are as follows:
\small
\[\footnotesize
\left(
\begin{array}{cccccccc}
\text{0x}86~& \text{0x}AF~& \text{0x}57~& \text{0x}A7~& \text{0x}CE~& \text{0x}42~& \text{0x}9F~& \text{0x}D\\
\text{0x}1F~& \text{0x}6~& \text{0x}6C~& \text{0x}9A~& \text{0x}DC~& \text{0x}E3~& \text{0x}D7~& \text{0x}93\\
\text{0x}85~& \text{0x}69~& \text{0x}FF~& \text{0x}28~& \text{0x}DC~& \text{0x}65~& \text{0x}51~& \text{0x}A7\\
\text{0x}46~& \text{0x}B2~& \text{0x}6~& \text{0x}F0~& \text{0x}73~& \text{0x}52~& \text{0x}EC~& \text{0x}29\\
\text{0x}41~& \text{0x}BD~& \text{0x}6A~& \text{0x}B3~& \text{0x}DE~& \text{0x}79~& \text{0x}BE~& \text{0x}5C\\
\text{0x}2D~& \text{0x}EB~& \text{0x}8A~& \text{0x}D6~& \text{0x}6C~& \text{0x}6D~& \text{0x}8F~& \text{0x}68\\
\text{0x}13~& \text{0x}A1~& \text{0x}B8~& \text{0x}E3~& \text{0x}FF~& \text{0x}4~& \text{0x}5A~& \text{0x}D8\\
\text{0x}CF~& \text{0x}C6~& \text{0x}BA~& \text{0x}8~& \text{0x}8F~& \text{0x}D9~& \text{0x}D0~& \text{0x}1C
\end{array}
\right),
\]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\[\footnotesize
\left(
\begin{array}{cccccccc}
\text{0x}F8~& \text{0x}59~& \text{0x}42~& \text{0x}9C~& \text{0x}ED~& \text{0x}1B~& \text{0x}DD~& \text{0x}F2\\
\text{0x}AF~& \text{0x}FF~& \text{0x}20~& \text{0x}4F~& \text{0x}81~& \text{0x}17~& \text{0x}E3~& \text{0x}9A\\
\text{0x}82~& \text{0x}A8~& \text{0x}F5~& \text{0x}A7~& \text{0x}3E~& \text{0x}E8~& \text{0x}35~& \text{0x}C7\\
\text{0x}45~& \text{0x}6D~& \text{0x}67~& \text{0x}A0~& \text{0x}75~& \text{0x}8B~& \text{0x}A1~& \text{0x}4C\\
\text{0x}B2~& \text{0x}BD~& \text{0x}78~& \text{0x}B8~& \text{0x}E7~& \text{0x}AB~& \text{0x}BE~& \text{0x}93\\
\text{0x}62~& \text{0x}49~& \text{0x}44~& \text{0x}D8~& \text{0x}DA~& \text{0x}87~& \text{0x}EC~& \text{0x}F3\\
\text{0x}F8~& \text{0x}D6~& \text{0x}8D~& \text{0x}96~& \text{0x}4D~& \text{0x}63~& \text{0x}C4~& \text{0x}E7\\
\text{0x}12~& \text{0x}77~& \text{0x}1E~& \text{0x}F1~& \text{0x}D9~& \text{0x}7E~& \text{0x}32~& \text{0x}1
\end{array}
\right),
\]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


For $n=16$, we resort to coding theory in order to reduce the search space. Note that, to verify the 1st and 2nd conditions for linear matrices built upon cyclic codes, it suffices to verify them for a {\it single row}. Moreover, the dual code of a cyclic code remains cyclic~\cite[Theorem 4.2.6]{DBLP:books/cu/HuffmanP03}, which enables efficiently verifying the 3rd and 4th conditions for its inverse. By the above, we enumerate cyclic code-based matrices and verify if they satisfy Definition \ref{defn:good-T}. Below we provide a candidate for $n = 8$ and $w = 16$ using the primitive polynomial $x^8+x^4+x^3+x^2+1$.
\[\tiny\arraycolsep=1.4pt\def\arraystretch{2.2}
\left(
\begin{array}{cccccccccccccccc}
\text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D\\
\text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D\\
\text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10\\
\text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE\\
\text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66\\
\text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7\\
\text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85\\
\text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8\\
\text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A\\
\text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A\\
\text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6\\
\text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87\\
\text{0x}2C~& \text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30\\
\text{0x}4C~& \text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C\\
\text{0x}2~& \text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C\\
\text{0x}9D~& \text{0x}7D~& \text{0x}10~& \text{0x}BE~& \text{0x}66~& \text{0x}F7~& \text{0x}85~& \text{0x}A8~& \text{0x}6A~& \text{0x}9A~& \text{0x}A6~& \text{0x}87~& \text{0x}30~& \text{0x}2C~& \text{0x}4C~& \text{0x}9D
\end{array}
\right).
\]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%$A^{-1}$=\[\tiny
%\left(
%\begin{array}{cccccccccccccccc}
%\text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F\\
%\text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0\\
%\text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F\\
%\text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37\\
%\text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43\\
%\text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75\\
%\text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9\\
%\text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31\\
%\text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B\\
%\text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99\\
%\text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7\\
%\text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52\\
%\text{0x}B5~& \text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0\\
%\text{0x}D1~& \text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5\\
%\text{0x}2B~& \text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1\\
%\text{0x}5F~& \text{0x}E0~& \text{0x}8F~& \text{0x}37~& \text{0x}43~& \text{0x}75~& \text{0x}9~& \text{0x}31~& \text{0x}4B~& \text{0x}99~& \text{0x}C7~& \text{0x}52~& \text{0x}D0~& \text{0x}B5~& \text{0x}D1~& \text{0x}2B
%\end{array}
%\right).
%\]






\end{document}

